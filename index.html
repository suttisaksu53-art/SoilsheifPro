<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบริหารจัดการตัวอย่างดินเพื่องานวิเคราะห์ดินในห้องปฏิบัติการ กลุ่มวิจัยเคมีดิน</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .btn-primary { @apply bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200; }
        .btn-secondary { @apply bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-colors duration-200; }
        .btn-success { @apply bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200; }
        .status-badge { position: fixed; bottom: 20px; right: 20px; padding: 8px 16px; border-radius: 50px; font-size: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 40; display: flex; align-items: center; gap: 8px; }
        .status-online { background-color: #10b981; color: white; }
        .status-demo { background-color: #f59e0b; color: white; }
        .nav-item.active { background-color: #059669; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .nav-item-highlight { background-color: #fffbeb; color: #92400e; border: 1px solid #fcd34d; font-weight: bold; }
        .nav-item-highlight:hover { background-color: #fef3c7; }
        .nav-item-highlight.active { background-color: #d97706; color: white; border-color: #b45309; }
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        #mobile-overlay { transition: opacity 0.3s ease-in-out; }
        .item-checkbox { width: 1.2rem; height: 1.2rem; cursor: pointer; accent-color: #10b981; }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <div id="mobile-overlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-800 text-white flex-col flex z-50 transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-300">
        <div class="p-6 border-b border-slate-700 flex items-center space-x-3">
            <div class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center"><i class="fa-solid fa-flask text-xl"></i></div>
            <div><h1 class="font-bold text-lg">Soilsheif Pro System</h1><p class="text-xs text-slate-400">กลุ่มวิจัยเคมีดิน</p></div>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto" id="nav-container"></nav>
        <div class="p-4 border-t border-slate-700">
            <div class="flex items-center space-x-3 mb-4 cursor-pointer hover:bg-slate-700 p-2 rounded" onclick="router('profile')">
                <div class="w-8 h-8 bg-slate-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-user text-sm"></i></div>
                <div class="flex-1 overflow-hidden"><p id="nav-username" class="text-sm font-semibold truncate">User</p><p class="text-xs text-slate-400">แก้ไขข้อมูลส่วนตัว</p></div>
            </div>
            <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm transition-colors"><i class="fa-solid fa-right-from-bracket mr-2"></i> ออกจากระบบ</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative w-full">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center z-20">
            <div id="header-title" class="font-bold text-emerald-700 text-lg md:text-xl truncate">Soilsheif Pro System</div>
            <button onclick="toggleSidebar()" class="text-gray-600 p-2 rounded hover:bg-gray-100 md:hidden"><i class="fa-solid fa-bars text-xl"></i></button>
        </header>
        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 relative"></div>
        <div id="status-badge" class="status-badge status-demo hidden"><i class="fa-solid fa-circle-info"></i><span id="status-text">โหมดจำลอง</span></div>
    </main>

    <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-[200] flex items-center justify-center hidden">
        <div class="text-center">
            <i class="fa-solid fa-spinner fa-spin text-5xl text-emerald-600 mb-4"></i>
            <p class="text-emerald-800 font-bold text-lg animate-pulse" id="loading-text">กำลังโหลดข้อมูล...</p>
        </div>
    </div>

    <div id="modal-container"></div>

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col relative">
            <div class="bg-emerald-600 p-6 text-white text-center">
                <i class="fa-solid fa-flask text-4xl mb-3"></i>
                <h2 class="text-2xl font-bold">กลุ่มวิจัยเคมีดิน</h2>
                <p class="text-emerald-100 text-sm">ระบบบริหารจัดการตัวอย่างดิน</p>
            </div>
            <div class="p-8">
                <div class="flex mb-6 border-b">
                    <button onclick="showLoginTab('login')" id="tab-login" class="flex-1 pb-2 border-b-2 border-emerald-600 font-semibold text-emerald-600">เข้าสู่ระบบ</button>
                    <button onclick="showLoginTab('register')" id="tab-register" class="flex-1 pb-2 border-b-2 border-transparent text-gray-500 hover:text-emerald-600">ลงทะเบียน</button>
                </div>
                
                <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้ใช้</label><input type="text" id="login-user" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label><input type="password" id="login-pass" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" required></div>
                    <div class="flex items-center"><input type="checkbox" id="remember-me" class="mr-2"><label for="remember-me" class="text-sm text-gray-600">จำการเข้าสู่ระบบไว้</label></div>
                    <div id="login-error-msg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-sm"><span class="block sm:inline">ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง</span></div>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded-lg transition-colors">เข้าสู่ระบบ</button>
                </form>

                <form id="register-form" onsubmit="handleRegister(event)" class="space-y-4 hidden">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้ใช้</label><input type="text" id="reg-user" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label><input type="password" id="reg-pass" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">ยืนยันรหัสผ่าน</label><input type="password" id="reg-pass-confirm" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล</label><input type="text" id="reg-name" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" required></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">กลุ่มที่สังกัด</label>
                        <select id="reg-group" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                            <option value="ฝ่ายบริหารทั่วไป">ฝ่ายบริหารทั่วไป</option>
                            <option value="กลุ่มวิจัยเคมีดิน">กลุ่มวิจัยเคมีดิน</option>
                            <option value="กลุ่มวิจัยกายภาพดิน">กลุ่มวิจัยกายภาพดิน</option>
                            <option value="กลุ่มวิจัยสิ่งแวดล้อม">กลุ่มวิจัยสิ่งแวดล้อม</option>
                            <option value="กลุ่มวิเคราะห์ วิจัย พืช ปุ๋ย และสิ่งปรับปรุงดิน">กลุ่มวิเคราะห์ วิจัย พืช ปุ๋ย และสิ่งปรับปรุงดิน</option>
                            <option value="กลุ่มวิจัยแร่และจุลสัณฐานดิน">กลุ่มวิจัยแร่และจุลสัณฐานดิน</option>
                            <option value="กลุ่มมาตรฐานและพัฒนาระบบการวิเคราะห์">กลุ่มมาตรฐานและพัฒนาระบบการวิเคราะห์</option>
                            <option value="กลุ่มวิทยบริการ">กลุ่มวิทยบริการ</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded-lg transition-colors">ลงทะเบียน</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const MOCK_DELAY = 250;
        const API_URL = "https://script.google.com/macros/s/AKfycbzb3O1kWnyJtD7jPor_rfnJOrD9df1Jzjb66QtBXeIzgyKZHXRq8FramTk6RGptFCRKLQ/exec";
        const SECONDARY_DB_URL = "https://docs.google.com/spreadsheets/d/1mPcLcY-vC3_xpSg8BKYplGoENP4U_koiOgiUKu33P4Q/edit?gid=418256453#gid=418256453";
        const DEPARTMENTS = ["ฝ่ายบริหารทั่วไป", "กลุ่มวิจัยเคมีดิน", "กลุ่มวิจัยกายภาพดิน", "กลุ่มวิจัยสิ่งแวดล้อม", "กลุ่มวิเคราะห์ วิจัย พืช ปุ๋ย และสิ่งปรับปรุงดิน", "กลุ่มวิจัยแร่และจุลสัณฐานดิน", "กลุ่มมาตรฐานและพัฒนาระบบการวิเคราะห์", "กลุ่มวิทยบริการ"];
        
        let rowsPerPage = 20;
        let currentUser = null, items = [], events = [], userList = [], isRealMode = true;
        let statusChartInstance = null, monthlyChartInstance = null, receivedSamplesChartInstance = null, receivedReceiptsChartInstance = null, reportedChartInstance = null, userActivityChartInstance = null;
        let currentView = 'dashboard';
        let currentPage = 1, searchTerm = '';
        let docSettings = {};

        const mockItems = [{ id: '1', receiptNo: 'S-66001', qty: 5, dateReceived: '2023-10-01', layer: 'A1', params: 'pH, EC, OM', status: 'Available', holder: '-', disposalPref: 'รับคืน', dateReported: '', disposalStatus: '' }];
        const mockEvents = [];
        const mockUsers = [{ username: 'admin', password: 'admin123', name: 'Admin System', group: 'IT Support', status: 'Approved', canReport: true, canManage: true, canDispose: true }];

        // --- 2. AUTH FUNCTIONS ---
        async function handleLogin(e) {
            e.preventDefault(); 
            document.getElementById('login-error-msg').classList.add('hidden');
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const remember = document.getElementById('remember-me').checked;
            
            showLoading("กำลังตรวจสอบข้อมูล...");
            try {
                const res = await apiCall('login', { username: user, password: pass }, false); 
                if (res.status === 'success') {
                    showLoading("กำลังเข้าสู่ระบบ...");
                    currentUser = res.user;
                    if (remember) localStorage.setItem('soilAppUser', JSON.stringify(currentUser));
                    document.getElementById('login-screen').classList.add('hidden');
                    renderSidebar();
                    updateNavUser();
                    showLoading("กำลังดาวน์โหลดข้อมูลล่าสุด...");
                    await refreshData();
                    router('dashboard');
                } else {
                    hideLoading();
                    const errorDiv = document.getElementById('login-error-msg');
                    errorDiv.querySelector('span').textContent = res.message || "เกิดข้อผิดพลาดในการเข้าสู่ระบบ";
                    errorDiv.classList.remove('hidden');
                }
            } catch (err) { hideLoading(); alert("เกิดข้อผิดพลาดในการเชื่อมต่อ: " + err.message); }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const pass = document.getElementById('reg-pass').value;
            const passConfirm = document.getElementById('reg-pass-confirm').value;
            if (pass !== passConfirm) { alert("รหัสผ่านไม่ตรงกัน กรุณาตรวจสอบอีกครั้ง"); return; }
            const payload = { username: document.getElementById('reg-user').value, password: pass, name: document.getElementById('reg-name').value, group: document.getElementById('reg-group').value };
            showLoading("กำลังลงทะเบียน...");
            const res = await apiCall('register', payload, false); 
            hideLoading();
            if (res.status === 'success') { alert('ลงทะเบียนสำเร็จ! โปรดแจ้ง Admin เพื่อทำการอนุมัติสิทธิ์ก่อนเริ่มใช้งาน'); showLoginTab('login'); } else { alert(res.message); }
        }

        // --- 3. HELPER FUNCTIONS ---
        function showLoading(text="กำลังโหลดข้อมูล...") { document.getElementById('loading-text').textContent=text; document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('mobile-overlay').classList.toggle('hidden'); }
        function closeSidebar() { if(window.innerWidth < 768) { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('mobile-overlay').classList.add('hidden'); } }
        function updateStatusBadge() { 
            const b=document.getElementById('status-badge'); b.classList.remove('hidden'); 
            b.className = isRealMode?'status-badge status-online':'status-badge status-demo'; 
            b.innerHTML = isRealMode?'<i class="fa-solid fa-wifi"></i> <span>ออนไลน์ (Google Sheet)</span>':'<i class="fa-solid fa-triangle-exclamation"></i> <span>โหมดจำลอง</span>'; 
        }
        function formatDateTh(d,t=true) { if(!d)return'-'; const dt=new Date(d); if(isNaN(dt))return d; const o={year:'numeric',month:'short',day:'numeric'}; if(t){o.hour='2-digit';o.minute='2-digit';o.hour12=false;} return dt.toLocaleString('th-TH',o); }
        function formatDateForPDF(d) { if(!d)return'-'; const dt=new Date(d); if(isNaN(dt))return d; return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`; }
        function calculateDaysRemaining(r) { if(!r)return-1; return Math.ceil(Math.abs(new Date()-new Date(r))/(1000*60*60*24)); }
        
        function updateRowsPerPage(v) { rowsPerPage=parseInt(v); currentPage=1; renderContent(); }
        function renderPagination(total, funcName) { const pages=Math.ceil(total/rowsPerPage); if(pages<=1)return''; return `<div class="flex justify-center items-center gap-2 mt-4 p-4"><button onclick="${funcName}(${currentPage-1})" ${currentPage===1?'disabled class="opacity-50 cursor-not-allowed"':''} class="px-3 py-1 bg-white border rounded hover:bg-gray-50"><i class="fa-solid fa-chevron-left"></i></button><span class="text-sm text-gray-600">หน้า ${currentPage} จาก ${pages}</span><button onclick="${funcName}(${currentPage+1})" ${currentPage===pages?'disabled class="opacity-50 cursor-not-allowed"':''} class="px-3 py-1 bg-white border rounded hover:bg-gray-50"><i class="fa-solid fa-chevron-right"></i></button></div>`; }
        function changePage(n) { currentPage=n; updateTableData(); }
        function handleSearch(t) { searchTerm=t.toLowerCase(); currentPage=1; updateTableData(); }
        
        function getUserInfo(u) { if(u==='admin')return {name:'Admin System',group:'IT Support'}; const f=userList.find(us=>us.username===u); return f?{name:f.name,group:f.group}:{name:u,group:'-'}; }
        
        // --- 4. INIT LOGIC (FIXED) ---
        function updateNavUser() { if(currentUser) document.getElementById('nav-username').textContent=currentUser.name; }
        
        function updateNavAndRedirect() { 
            renderSidebar(); 
            updateNavUser(); 
            refreshData().then(()=>router('dashboard')); 
        }

        function init() { 
            localStorage.removeItem('customApiUrl'); 
            const u = localStorage.getItem('soilAppUser'); 
            isRealMode = true; 
            updateStatusBadge(); 
            if(u){ 
                try{ currentUser = JSON.parse(u); document.getElementById('login-screen').classList.add('hidden'); updateNavAndRedirect(); }
                catch(e){ localStorage.removeItem('soilAppUser'); } 
            } 
        }

        function logout() { localStorage.removeItem('soilAppUser'); location.reload(); }
        function showLoginTab(t) { document.getElementById('login-error-msg').classList.add('hidden'); document.getElementById('login-form').classList.toggle('hidden', t!=='login'); document.getElementById('register-form').classList.toggle('hidden', t!=='register'); document.getElementById('tab-login').className = t==='login'?"flex-1 pb-2 border-b-2 border-emerald-600 font-semibold text-emerald-600":"flex-1 pb-2 border-b-2 border-transparent text-gray-500 hover:text-emerald-600"; document.getElementById('tab-register').className = t==='register'?"flex-1 pb-2 border-b-2 border-emerald-600 font-semibold text-emerald-600":"flex-1 pb-2 border-b-2 border-transparent text-gray-500 hover:text-emerald-600"; }
        
        async function loadThaiFont(doc) { try { const res = await fetch("https://raw.githubusercontent.com/google/fonts/main/ofl/sarabun/Sarabun-Regular.ttf"); if (!res.ok) throw new Error("Font fetch failed"); const blob = await res.blob(); const reader = new FileReader(); return new Promise(resolve => { reader.onload = function() { const base64 = reader.result.split(',')[1]; doc.addFileToVFS('Sarabun-Regular.ttf', base64); doc.addFont('Sarabun-Regular.ttf', 'Sarabun', 'normal'); doc.setFont('Sarabun'); resolve(); }; reader.readAsDataURL(blob); }); } catch (e) { console.error("Error loading font:", e); alert("ไม่สามารถโหลดฟอนต์ภาษาไทยได้"); } }

        // --- 5. API & DATA ---
        async function apiCall(action, payload={}, autoHide=true) {
            if(autoHide) showLoading("กำลังประมวลผล...");
            if(!isRealMode) { return new Promise(r=>{ setTimeout(()=>{ if(autoHide)hideLoading(); r({status:'success'}); }, MOCK_DELAY); }); }
            try {
                const c = new AbortController(); const t = setTimeout(()=>c.abort(), 60000);
                const r = await fetch(API_URL, { method:'POST', redirect:'follow', headers:{ "Content-Type":"text/plain;charset=utf-8" }, body:JSON.stringify({action,...payload}), signal:c.signal });
                clearTimeout(t); if(!r.ok) throw new Error(`HTTP ${r.status}`); const txt=await r.text();
                const d=JSON.parse(txt); if(autoHide)hideLoading(); return d;
            } catch(e) { if(autoHide)hideLoading(); console.error(e); return {status:'error', message:e.name==='AbortError'?"Timeout":e.message}; }
        }

        async function refreshData() {
            const [i, e, u, s] = await Promise.all([apiCall('getItems',{},false), apiCall('getHistory',{},false), apiCall('getUsers',{},false), apiCall('getSettings',{},false)]);
            if(i.status==='success') items=i.items||[]; if(e.status==='success') events=e.events||[]; if(u.status==='success') userList=u.users||[]; if(s.status==='success') docSettings=s.settings||{};
            hideLoading();
        }

        // --- 6. ACTION FUNCTIONS ---
        async function processTransaction(type, itemId) {
            if (!itemId) return alert('รหัสสินค้าไม่ถูกต้อง');
            const action = type === 'borrow' ? 'borrowItem' : 'returnItem';
            const res = await apiCall(action, { itemId: itemId, username: currentUser.username });
            if (res.status === 'success') {
                alert(type === 'borrow' ? 'เบิกสำเร็จ' : 'คืนสำเร็จ');
                await refreshData();
                router('borrow');
            } else {
                alert(res.message);
            }
        }
        
        async function handleSaveItem(e, id) { e.preventDefault(); const newItem = { id: id, receiptNo: document.getElementById('m-receipt').value, dateReceived: document.getElementById('m-date').value, qty: document.getElementById('m-qty').value, layer: "'" + document.getElementById('m-layer').value, params: document.getElementById('m-params').value, disposalPref: document.getElementById('m-pref').value }; const action = id ? 'editItem' : 'addItem'; const res = await apiCall(action, { item: newItem }); if (res.status === 'success') { document.getElementById('modal-container').innerHTML = ''; await refreshData(); router('items'); } else { alert(res.message); } }
        async function syncExternalData() { const url = SECONDARY_DB_URL; if(!confirm("ยืนยันการอัปเดตข้อมูลจาก Database สำรอง?")) return; showLoading("กำลังซิงค์ข้อมูล..."); const res = await apiCall('syncExternalData', { url: url }, false); hideLoading(); alert(res.message); if(res.status === 'success') { await refreshData(); router('items'); } }
        async function handleProfileUpdate(e) { e.preventDefault(); const pass = document.getElementById('edit-pass').value; const updateData = { username: currentUser.username, name: document.getElementById('edit-name').value, group: document.getElementById('edit-group').value, password: pass ? pass : currentUser.password }; const res = await apiCall('updateProfile', updateData); if(res.status === 'success') { currentUser.name = updateData.name; currentUser.group = updateData.group; if(pass) currentUser.password = pass; localStorage.setItem('soilAppUser', JSON.stringify(currentUser)); alert('แก้ไขข้อมูลสำเร็จ'); updateNavUser(); } }
        async function approveUser(username) { if(!confirm('ยืนยันอนุมัติ?')) return; const res = await apiCall('approveUser', { username: username }); if(res.status === 'success') { alert('เรียบร้อย'); router('users'); } else { alert(res.message); } }
        async function toggleUserPermission(username, type, isChecked) { const res = await apiCall('toggleUserPermission', { username: username, type: type, value: isChecked }); if(res.status !== 'success') { alert(res.message); router('users'); } }
        async function deleteUser(username) { if(!confirm('ยืนยันลบ?')) return; const res = await apiCall('deleteUser', { username: username }); if(res.status === 'success') { router('users'); } else { alert(res.message); } }
        function openReportDateModal(id, receiptNo) { const today = new Date().toISOString().split('T')[0]; document.getElementById('modal-container').innerHTML = `<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 animate-[fadeIn_0.2s_ease-out]"><h3 class="text-xl font-bold mb-4 text-blue-700">ยืนยันการรายงานผล</h3><p class="text-sm text-gray-600 mb-4">เลขรับ: <b>${receiptNo}</b></p><div class="mb-4"><label class="block text-sm font-bold text-gray-700 mb-1">เลือกวันที่</label><input type="date" id="report-date-picker" value="${today}" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></div><div class="flex justify-end space-x-2 border-t pt-4"><button onclick="document.getElementById('modal-container').innerHTML=''" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">ยกเลิก</button><button onclick="confirmReport('${id}')" class="btn-primary bg-blue-600 hover:bg-blue-700">ยืนยัน</button></div></div></div>`; }
        async function confirmReport(id) { const date = document.getElementById('report-date-picker').value; if(!date) return alert("กรุณาเลือกวันที่"); document.getElementById('modal-container').innerHTML = ''; const res = await apiCall('reportItem', { id: id, date: date }); if(res.status === 'success') { alert('เรียบร้อย'); await refreshData(); router('report'); } else { alert(res.message); } }
        async function handleDisposeItem(id, pref) { if(!confirm(`ยืนยันการดำเนินการ (${pref === 'รับคืน' ? 'คืนเจ้าของ' : 'ทิ้ง'})?`)) return; const res = await apiCall('disposeItem', { id: id }); if(res.status === 'success') { alert('เรียบร้อย'); await refreshData(); router(currentView); } else { alert(res.message); } }
        async function deleteItem(id) { if (!confirm('ยืนยันที่จะลบรายการนี้?')) return; const res = await apiCall('deleteItem', { id }); if (res.status === 'success') { await refreshData(); router(currentView); } }
        async function deleteEvent(id) { if (!confirm('ยืนยันที่จะลบประวัตินี้?')) return; const res = await apiCall('deleteEvent', { id }); if (res.status === 'success') { await refreshData(); router('history'); } }
        function toggleAllItems(source, btnId) { const checkboxes = document.querySelectorAll('.item-checkbox'); checkboxes.forEach(cb => cb.checked = source.checked); checkSelection(btnId); }
        function checkSelection(btnId) { const checkedCount = document.querySelectorAll('.item-checkbox:checked').length; const btn = document.getElementById(btnId); if(btn) { if(checkedCount > 0) { btn.classList.remove('hidden'); btn.querySelector('span') ? btn.querySelector('span').textContent = checkedCount : null; } else btn.classList.add('hidden'); } }
        async function deleteSelected(type) { const checked = document.querySelectorAll('.item-checkbox:checked'); if(checked.length === 0) return; if(!confirm(`ยืนยันการลบ ${checked.length} รายการ?`)) return; showLoading(`กำลังลบ...`); for(let cb of checked) { if(type === 'event') await apiCall('deleteEvent', { id: cb.value }, false); else await apiCall('deleteItem', { id: cb.value }, false); } hideLoading(); await refreshData(); router(currentView); }

        function downloadTemplate() { const wb = XLSX.utils.book_new(); const ws_data = [["เลขรับ", "จำนวนตัวอย่าง", "วันที่รับ", "ชั้นวาง", "พารามิเตอร์", "การจำหน่ายตัวอย่าง"], ["S-67001", 1, "2024-01-20", "A1", "pH, EC", "รับคืน"], ["S-67002", 5, "2024-01-20", "B2", "N, P, K", "ทิ้ง"]]; const ws = XLSX.utils.aoa_to_sheet(ws_data); XLSX.utils.book_append_sheet(wb, ws, "Template"); XLSX.writeFile(wb, "Soil_Sample_Template.xlsx"); }
        function exportHistoryXLSX() { if (typeof XLSX === 'undefined') { alert('Library Excel ยังไม่พร้อมใช้งาน'); return; } const wb = XLSX.utils.book_new(); const ws_data = events.map(e => { const info = getUserInfo(e.user); return { "เวลา": formatDateForPDF(e.date), "ประเภทรายการ": e.type === 'Borrow' ? 'เบิกออก' : 'นำคืน', "เลขรับตัวอย่าง": e.itemName, "ผู้ดำเนินการ (User)": e.user, "ชื่อ-สกุล": info.name, "กลุ่มงาน": info.group, "หมายเหตุ": e.note }; }); const ws = XLSX.utils.json_to_sheet(ws_data); XLSX.utils.book_append_sheet(wb, ws, "Report"); XLSX.writeFile(wb, "History_Report.xlsx"); }
        function exportItemsXLSX() { if (typeof XLSX === 'undefined') { alert('Library Excel ยังไม่พร้อมใช้งาน'); return; } const wb = XLSX.utils.book_new(); const ws_data = items.map(i => ({ "เลขรับ": i.receiptNo, "จำนวน": i.qty, "ชั้นเก็บ": i.layer, "วันที่รับ": formatDateTh(i.dateReceived, false), "พารามิเตอร์": i.params, "การจำหน่ายตัวอย่าง": i.disposalPref, "สถานะ": i.status })); const ws = XLSX.utils.json_to_sheet(ws_data); XLSX.utils.book_append_sheet(wb, ws, "SoilItems"); XLSX.writeFile(wb, "Soil_Samples_List.xlsx"); }
        function exportItemsPDF() { if (!window.jspdf) { alert('Library PDF ยังไม่พร้อมใช้งาน'); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF(); const settings = docSettings['items'] || { footerLeft: '', footerRight: '' }; loadThaiFont(doc).then(() => { doc.text("Soil Samples List", 14, 20); doc.setFontSize(10); doc.text(`Generated on ${formatDateForPDF(new Date().toISOString())}`, 14, 30); const tableColumn = ["Sample No", "Qty", "Layer", "Date", "Status"]; const tableRows = items.map(i => [i.receiptNo, i.qty, i.layer, formatDateForPDF(i.dateReceived), i.status]); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, styles: { font: 'Sarabun', fontStyle: 'normal' }, didDrawPage: function(d){ doc.text('Page '+doc.internal.getNumberOfPages(), 195, 10, {align:'right'}); if(settings.footerLeft) doc.text(settings.footerLeft, 14, 280); if(settings.footerRight) doc.text(settings.footerRight, 195, 280, {align:'right'}); } }); doc.save("soil-items-list.pdf"); }); }
        function exportUsersPDF() { if (!window.jspdf) { alert('Library PDF ยังไม่พร้อมใช้งาน'); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF(); const settings = docSettings['users'] || { footerLeft: '', footerRight: '' }; loadThaiFont(doc).then(() => { doc.text("User Management Report", 14, 20); doc.setFontSize(10); doc.text(`Generated on ${formatDateForPDF(new Date().toISOString())}`, 14, 30); const tableColumn = ["Username", "Name", "Group", "Status"]; const tableRows = userList.map(u => [u.username, u.name, u.group, u.status]); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, styles: { font: 'Sarabun', fontStyle: 'normal' }, didDrawPage: function(d){ doc.text('Page '+doc.internal.getNumberOfPages(), 195, 10, {align:'right'}); if(settings.footerLeft) doc.text(settings.footerLeft, 14, 280); if(settings.footerRight) doc.text(settings.footerRight, 195, 280, {align:'right'}); } }); doc.save("user-report.pdf"); }); }
        function exportDisposeXLSX(type) { if (typeof XLSX === 'undefined') { alert('Library Excel ยังไม่พร้อมใช้งาน'); return; } let overdueItems = []; if(type === 'return') overdueItems = items.filter(i => i.dateReported && i.disposalStatus !== 'Completed' && calculateDaysRemaining(i.dateReported) >= 60 && i.disposalPref === 'รับคืน'); else overdueItems = items.filter(i => i.dateReported && i.disposalStatus !== 'Completed' && calculateDaysRemaining(i.dateReported) >= 60 && i.disposalPref !== 'รับคืน'); const wb = XLSX.utils.book_new(); const ws_data = overdueItems.map(i => ({ "เลขรับ": i.receiptNo, "จำนวน": i.qty, "ชั้นเก็บ": i.layer, "วันที่รายงานผล": formatDateForPDF(i.dateReported), "เกินกำหนด(วัน)": calculateDaysRemaining(i.dateReported) })); const ws = XLSX.utils.json_to_sheet(ws_data); XLSX.utils.book_append_sheet(wb, ws, "List"); XLSX.writeFile(wb, `${type === 'return' ? 'Return_List' : 'Disposal_List'}.xlsx`); }
        function exportDisposePDF(type) { if (!window.jspdf) { alert('Library PDF ยังไม่พร้อมใช้งาน'); return; } let overdueItems = []; let settingsKey = 'dispose'; if(type === 'return') { overdueItems = items.filter(i => i.dateReported && i.disposalStatus !== 'Completed' && calculateDaysRemaining(i.dateReported) >= 60 && i.disposalPref === 'รับคืน'); settingsKey = 'return_customer'; } else { overdueItems = items.filter(i => i.dateReported && i.disposalStatus !== 'Completed' && calculateDaysRemaining(i.dateReported) >= 60 && i.disposalPref !== 'รับคืน'); } const { jsPDF } = window.jspdf; const doc = new jsPDF(); const settings = docSettings[settingsKey] || { footerLeft: '', footerRight: '' }; loadThaiFont(doc).then(() => { doc.text(type === 'return' ? "Return Samples Report" : "Disposal List Report", 14, 20); doc.setFontSize(10); doc.text(`Generated on ${formatDateForPDF(new Date().toISOString())}`, 14, 30); const tableColumn = ["Sample No", "Qty", "Layer", "Report Date", "Overdue (Days)"]; const tableRows = overdueItems.map(i => [i.receiptNo, i.qty, i.layer, formatDateForPDF(i.dateReported), calculateDaysRemaining(i.dateReported)]); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, styles: { font: 'Sarabun', fontStyle: 'normal' }, didDrawPage: function(d){ doc.text('Page '+doc.internal.getNumberOfPages(), 195, 10, {align:'right'}); if(settings.footerLeft) doc.text(settings.footerLeft, 14, 280); if(settings.footerRight) doc.text(settings.footerRight, 195, 280, {align:'right'}); } }); doc.save(`${type === 'return' ? 'return-report' : 'disposal-report'}.pdf`); }); }
        function exportStatusXLSX() { if (typeof XLSX === 'undefined') { alert('Library Excel ยังไม่พร้อมใช้งาน'); return; } const wb = XLSX.utils.book_new(); const ws_data = items.map(i => ({ "เลขรับ": i.receiptNo, "จำนวน": i.qty, "ชั้นเก็บ": i.layer, "สถานะ": i.status, "ผู้เบิก": i.holder, "พารามิเตอร์": i.params, "วันที่รายงาน": formatDateTh(i.dateReported, false) })); const ws = XLSX.utils.json_to_sheet(ws_data); XLSX.utils.book_append_sheet(wb, ws, "Status"); XLSX.writeFile(wb, "Status_Report.xlsx"); }
        function exportStatusPDF() { if (!window.jspdf) { alert('Library PDF ยังไม่พร้อมใช้งาน'); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF(); const settings = docSettings['status'] || { footerLeft: '', footerRight: '' }; loadThaiFont(doc).then(() => { doc.text("Status Report", 14, 20); doc.setFontSize(10); doc.text(`Generated on ${formatDateForPDF(new Date().toISOString())}`, 14, 30); const tableColumn = ["Sample No", "Qty", "Layer", "Status", "Holder", "Params"]; const tableRows = items.map(i => [i.receiptNo, i.qty, i.layer, i.status, i.holder, i.params]); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, styles: { font: 'Sarabun', fontStyle: 'normal' }, didDrawPage: function(d){ doc.text('Page '+doc.internal.getNumberOfPages(), 195, 10, {align:'right'}); if(settings.footerLeft) doc.text(settings.footerLeft, 14, 280); if(settings.footerRight) doc.text(settings.footerRight, 195, 280, {align:'right'}); } }); doc.save("status-report.pdf"); }); }
        function exportReportXLSX() { if (typeof XLSX === 'undefined') { alert('Library Excel ยังไม่พร้อมใช้งาน'); return; } const filtered = items.filter(i => !i.dateReported); const wb = XLSX.utils.book_new(); const ws_data = filtered.map(i => ({ "เลขรับ": i.receiptNo, "วันที่รับ": formatDateTh(i.dateReceived, false), "พารามิเตอร์": i.params })); const ws = XLSX.utils.json_to_sheet(ws_data); XLSX.utils.book_append_sheet(wb, ws, "PendingReport"); XLSX.writeFile(wb, "Pending_Analysis_Report.xlsx"); }
        function exportReportPDF() { if (!window.jspdf) { alert('Library PDF ยังไม่พร้อมใช้งาน'); return; } const filtered = items.filter(i => !i.dateReported); const { jsPDF } = window.jspdf; const doc = new jsPDF(); const settings = docSettings['report'] || { footerLeft: '', footerRight: '' }; loadThaiFont(doc).then(() => { doc.text("Pending Analysis Report", 14, 20); doc.setFontSize(10); doc.text(`Generated on ${formatDateForPDF(new Date().toISOString())}`, 14, 30); const tableColumn = ["Sample No", "Date Received", "Params"]; const tableRows = filtered.map(i => [i.receiptNo, formatDateForPDF(i.dateReceived), i.params]); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, styles: { font: 'Sarabun', fontStyle: 'normal' }, didDrawPage: function(d){ doc.text('Page '+doc.internal.getNumberOfPages(), 195, 10, {align:'right'}); if(settings.footerLeft) doc.text(settings.footerLeft, 14, 280); if(settings.footerRight) doc.text(settings.footerRight, 195, 280, {align:'right'}); } }); doc.save("pending-analysis-report.pdf"); }); }
        function exportHistoryPDF() { if (!window.jspdf) { alert('Library PDF ยังไม่พร้อมใช้งาน'); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF('l'); const settings = docSettings['history'] || { footerLeft: '', footerRight: '' }; loadThaiFont(doc).then(() => { doc.text("History Report", 14, 20); doc.setFontSize(10); doc.text(`Generated by: ${currentUser.username} on ${formatDateForPDF(new Date().toISOString())}`, 14, 30); const tableColumn = ["Time", "Type", "Sample No", "User", "Name", "Group"]; const tableRows = events.map(e => { const info = getUserInfo(e.user); return [formatDateForPDF(e.date), e.type === 'Borrow' ? 'Borrow' : 'Return', e.itemName, e.user, info.name, info.group]; }); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, styles: { font: 'Sarabun', fontStyle: 'normal' }, didDrawPage: function(d){ doc.text('Page '+doc.internal.getNumberOfPages(), 285, 10, {align:'right'}); if(settings.footerLeft) doc.text(settings.footerLeft, 14, 200); if(settings.footerRight) doc.text(settings.footerRight, 285, 200, {align:'right'}); } }); doc.save("history-report.pdf"); }); }

        async function openSettingsModal(viewKey) {
            const settings = docSettings[viewKey] || { footerLeft: '', footerRight: '' };
            const modalHtml = `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 animate-[fadeIn_0.2s_ease-out]">
                        <h3 class="text-xl font-bold mb-4 text-slate-800">ตั้งค่าเอกสาร PDF</h3>
                        <p class="text-sm text-gray-500 mb-4">สำหรับเมนู: <b>${viewKey}</b></p>
                        <div class="space-y-3">
                            <div><label class="block text-sm font-bold text-gray-700 mb-1">ข้อความซ้ายล่าง</label><input type="text" id="footer-left" value="${settings.footerLeft}" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm font-bold text-gray-700 mb-1">ข้อความขวาล่าง</label><input type="text" id="footer-right" value="${settings.footerRight}" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="flex justify-end space-x-2 border-t pt-4 mt-4">
                            <button onclick="document.getElementById('modal-container').innerHTML=''" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">ยกเลิก</button>
                            <button onclick="saveSettings('${viewKey}')" class="btn-primary">บันทึก</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('modal-container').innerHTML = modalHtml;
        }

        async function saveSettings(viewKey) {
            const left = document.getElementById('footer-left').value;
            const right = document.getElementById('footer-right').value;
            const newSettings = { footerLeft: left, footerRight: right };
            
            showLoading("กำลังบันทึก...");
            const res = await apiCall('saveSettings', { type: viewKey, settings: newSettings }, false);
            hideLoading();
            
            if(res.status === 'success') {
                if(!docSettings[viewKey]) docSettings[viewKey] = {};
                docSettings[viewKey] = newSettings;
                document.getElementById('modal-container').innerHTML = '';
                alert('บันทึกเรียบร้อย');
            } else {
                alert(res.message);
            }
        }

        function renderSidebar() {
            if(!currentUser) return;
            const html = `
            <button id="nav-dashboard" onclick="router('dashboard')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center space-x-3 transition-colors"><i class="fa-solid fa-chart-pie w-6"></i> <span>แดชบอร์ด</span></button>
            <button id="nav-borrow" onclick="router('borrow')" class="nav-item-highlight w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3 transition-colors shadow-sm mb-2"><i class="fa-solid fa-hand-holding w-6"></i> <span>เบิก-คืน ตัวอย่าง</span></button>
            <button id="nav-status" onclick="router('status')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center space-x-3 transition-colors"><i class="fa-solid fa-list-check w-6"></i> <span>สถานะตัวอย่างทั้งหมด</span></button>
            <button id="nav-report" onclick="router('report')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center space-x-3 transition-colors text-blue-300"><i class="fa-solid fa-clipboard-check w-6"></i> <span>รายงานผล</span></button>
            <button id="nav-dispose" onclick="router('dispose')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center space-x-3 transition-colors text-orange-300"><i class="fa-solid fa-trash-can-arrow-up w-6"></i> <span>จำหน่ายตัวอย่าง</span></button>
            <button id="nav-return-customer" onclick="router('return_customer')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center space-x-3 transition-colors text-teal-300"><i class="fa-solid fa-rotate-left"></i> <span>การคืนตัวอย่าง</span></button>
            <button id="nav-items" onclick="router('items')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center space-x-3 transition-colors text-emerald-300"><i class="fa-solid fa-box-archive w-6"></i> <span>จัดการตัวอย่างดิน</span></button>
            ${currentUser.username==='admin'?`<div class="my-2 border-t border-slate-600"></div><button id="nav-users" onclick="router('users')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center space-x-3 transition-colors text-purple-300"><i class="fa-solid fa-users-gear w-6"></i> <span>จัดการผู้ใช้งาน (Admin)</span></button>`:''}
            <button id="nav-history" onclick="router('history')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center space-x-3 transition-colors"><i class="fa-solid fa-clock-rotate-left w-6"></i> <span>ประวัติ & รายงาน</span></button>`;
            document.getElementById('nav-container').innerHTML = html;
        }

        async function router(view) {
            currentView = view; currentPage = 1; searchTerm = ''; closeSidebar();
            
            const titles = { 'dashboard': 'แดชบอร์ดภาพรวม', 'status': 'สถานะตัวอย่างดิน', 'items': 'จัดการตัวอย่างดิน', 'borrow': 'เบิก-คืน', 'return_customer': 'การคืนตัวอย่าง', 'dispose': 'จำหน่ายตัวอย่าง', 'report': 'รายงานผล', 'history': 'ประวัติ', 'users': 'จัดการผู้ใช้', 'profile': 'ข้อมูลส่วนตัว' };
            document.getElementById('header-title').textContent = titles[view] || 'Soilsheif Pro';
            
            document.querySelectorAll('.nav-item, .nav-item-highlight').forEach(e => e.classList.remove('active', 'bg-emerald-600'));
            const active = document.getElementById('nav-'+(view==='return_customer'?'return-customer':view));
            if(active) active.classList.add('active');

            if (view === 'dashboard') renderDashboard(document.getElementById('content-area'));
            else renderContent();
        }

        function renderDashboard(container) {
            const totalReceipts = items.length;
            const totalQty = items.reduce((s, i) => s + (Number(i.qty)||0), 0);
            const borrowed = items.filter(i => i.status === 'Borrowed').length;
            const available = totalReceipts - borrowed;
            const mn = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            const stats = {}; const ua = {}; const now = new Date();
            
            events.forEach(e => {
                const d = new Date(e.date);
                if(d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear()) {
                    const u = e.user || 'Unknown'; ua[u] = (ua[u]||0)+1;
                }
            });
            const topUsers = Object.keys(ua).sort((a,b)=>ua[b]-ua[a]).slice(0,5);
            const topUserData = topUsers.map(u=>ua[u]);

            items.forEach(i => {
                if(i.dateReceived) {
                    const d = new Date(i.dateReceived); if(!isNaN(d)) { const k = `${mn[d.getMonth()]} ${d.getFullYear()+543}`; if(!stats[k]) stats[k] = { rec:0, smp:0, repSmp:0, sort:d.getTime() }; stats[k].rec++; stats[k].smp+=(Number(i.qty)||0); }
                }
                if(i.dateReported) {
                    const d = new Date(i.dateReported); if(!isNaN(d)) { const k = `${mn[d.getMonth()]} ${d.getFullYear()+543}`; if(!stats[k]) stats[k] = { rec:0, smp:0, repSmp:0, sort:d.getTime() }; stats[k].repSmp+=(Number(i.qty)||0); }
                }
            });

            const keys = Object.keys(stats).sort((a,b)=>stats[a].sort-stats[b].sort);
            const dRec = keys.map(k=>stats[k].rec); const dSmp = keys.map(k=>stats[k].smp); const dRep = keys.map(k=>stats[k].repSmp);

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-emerald-500"><div><p class="text-sm text-gray-500">จำนวนเลขรับทั้งหมด</p><p class="text-3xl font-bold">${totalReceipts}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-cyan-500"><div><p class="text-sm text-gray-500">จำนวนตัวอย่างดินทั้งหมด</p><p class="text-3xl font-bold">${totalQty}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500"><div><p class="text-sm text-gray-500">เลขรับพร้อมเบิก</p><p class="text-3xl font-bold">${available}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500"><div><p class="text-sm text-gray-500">เลขรับที่กำลังถูกเบิก</p><p class="text-3xl font-bold">${borrowed}</p></div></div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                     <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold mb-4">สถานะตัวอย่าง (เลขรับ)</h3><canvas id="statusChart"></canvas></div>
                     
                     <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold mb-4">ผู้ใช้งานที่มีความเคลื่อนไหวสูงสุด (เดือนนี้)</h3>
                        <canvas id="userActivityChart"></canvas>
                     </div>
                </div>
                
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold mb-4">สถิติการรับตัวอย่างรายเดือน (จำนวนตัวอย่างดิน)</h3><div class="h-80"><canvas id="recSmpChart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold mb-4">สถิติการรับตัวอย่างรายเดือน (จำนวนเลขรับ)</h3><div class="h-80"><canvas id="recRecChart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold mb-4">สถิติการรายงานผลรายเดือน (จำนวนตัวอย่างดิน)</h3><div class="h-80"><canvas id="reportedChart"></canvas></div></div>
                </div>
            `;

            setTimeout(() => {
                Chart.register(ChartDataLabels);
                if(statusChartInstance) statusChartInstance.destroy();
                const statusCtx = document.getElementById('statusChart');
                if (statusCtx) {
                    statusChartInstance = new Chart(statusCtx.getContext('2d'), { 
                        type: 'doughnut', 
                        data: { labels: ['ว่าง','ถูกเบิก'],datasets:[{data:[available,borrowed],backgroundColor:['#10b981','#f97316']}]}, 
                        options: { responsive: true, cutout: '70%', plugins: { datalabels: { color: '#fff', font: { weight: 'bold', size: 14 } } } } 
                    });
                }
                
                if(userActivityChartInstance) userActivityChartInstance.destroy();
                const uaCtx = document.getElementById('userActivityChart');
                if (uaCtx) {
                    userActivityChartInstance = new Chart(uaCtx.getContext('2d'), {
                        type: 'bar', indexAxis: 'y', 
                        data: { labels: topUsers, datasets: [{ label: 'ครั้ง', data: topUserData, backgroundColor: ['#8b5cf6', '#ec4899', '#f43f5e', '#a855f7', '#6366f1'], borderRadius: 4 }] },
                        options: { responsive: true, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', color: '#666', font: { weight: 'bold' } } } }
                    });
                }

                if(receivedSamplesChartInstance) receivedSamplesChartInstance.destroy();
                const recSmpCtx = document.getElementById('recSmpChart');
                if (recSmpCtx) {
                    receivedSamplesChartInstance = new Chart(recSmpCtx.getContext('2d'), {
                        type: 'bar', data: { labels: keys, datasets: [{ label: 'ตัวอย่าง', data: dSmp, backgroundColor: '#0ea5e9', borderRadius: 4 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { datalabels: { anchor: 'end', align: 'top', color: '#666', font: { weight: 'bold' }, offset: 4 } } }
                    });
                }

                if(receivedReceiptsChartInstance) receivedReceiptsChartInstance.destroy();
                const recRecCtx = document.getElementById('recRecChart');
                if (recRecCtx) {
                    receivedReceiptsChartInstance = new Chart(recRecCtx.getContext('2d'), {
                        type: 'bar', data: { labels: keys, datasets: [{ label: 'เลขรับ', data: dRec, backgroundColor: '#8b5cf6', borderRadius: 4 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { datalabels: { anchor: 'end', align: 'top', color: '#666', font: { weight: 'bold' }, offset: 4 } } }
                    });
                }

                if(reportedChartInstance) reportedChartInstance.destroy();
                const repSmpCtx = document.getElementById('reportedChart');
                if (repSmpCtx) {
                    reportedChartInstance = new Chart(repSmpCtx.getContext('2d'), {
                        type: 'bar', data: { labels: keys, datasets: [{ label: 'ตัวอย่างรายงานผล', data: dRep, backgroundColor: '#10b981', borderRadius: 4 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { datalabels: { anchor: 'end', align: 'top', color: '#666', font: { weight: 'bold' }, offset: 4 } } }
                    });
                }
            }, 100);
        }

        function renderContent() {
            const container = document.getElementById('content-area');
            const isAdmin = currentUser.username === 'admin';
            const canAct = isAdmin || (currentView === 'items' && currentUser.canManage) || (currentView === 'report' && currentUser.canReport) || ((currentView === 'dispose' || currentView === 'return_customer') && currentUser.canDispose);
            const pg = `<select onchange="updateRowsPerPage(this.value)" class="p-2 border rounded text-xs ml-2 bg-gray-50 focus:ring-2 focus:ring-emerald-500 outline-none"><option value="20" ${rowsPerPage==20?'selected':''}>20 แถว</option><option value="50" ${rowsPerPage==50?'selected':''}>50 แถว</option><option value="100" ${rowsPerPage==100?'selected':''}>100 แถว</option><option value="10000" ${rowsPerPage==10000?'selected':''}>ทั้งหมด</option></select>`;
            
            let btnSettings = '';
            if (isAdmin && ['items', 'report', 'dispose', 'return_customer', 'history', 'users'].includes(currentView)) {
                btnSettings = `<button onclick="openSettingsModal('${currentView}')" class="ml-2 btn-secondary text-xs px-2 py-1"><i class="fa-solid fa-cog"></i></button>`;
            }

            let exportBtns = '';
            if (currentView === 'history') {
                exportBtns = `<div class="flex bg-white rounded-lg shadow-sm border border-gray-200 p-1"><button onclick="exportHistoryXLSX()" class="px-3 py-1.5 text-gray-500 hover:text-emerald-600 rounded"><i class="fa-solid fa-file-excel text-lg"></i></button><div class="w-px bg-gray-200 my-1"></div><button onclick="exportHistoryPDF()" class="px-3 py-1.5 text-gray-500 hover:text-red-600 rounded"><i class="fa-solid fa-file-pdf text-lg"></i></button>${btnSettings}</div>`;
            } else if (currentView === 'dispose') {
                exportBtns = `<div class="flex bg-white rounded-lg shadow-sm border border-gray-200 p-1"><button onclick="exportDisposeXLSX('dispose')" class="px-3 py-1.5 text-gray-500 hover:text-emerald-600 rounded"><i class="fa-solid fa-file-excel text-lg"></i></button><div class="w-px bg-gray-200 my-1"></div><button onclick="exportDisposePDF('dispose')" class="px-3 py-1.5 text-gray-500 hover:text-red-600 rounded"><i class="fa-solid fa-file-pdf text-lg"></i></button>${btnSettings}</div>`;
            } else if (currentView === 'return_customer') {
                exportBtns = `<div class="flex bg-white rounded-lg shadow-sm border border-gray-200 p-1"><button onclick="exportDisposeXLSX('return')" class="px-3 py-1.5 text-gray-500 hover:text-emerald-600 rounded"><i class="fa-solid fa-file-excel text-lg"></i></button><div class="w-px bg-gray-200 my-1"></div><button onclick="exportDisposePDF('return')" class="px-3 py-1.5 text-gray-500 hover:text-red-600 rounded"><i class="fa-solid fa-file-pdf text-lg"></i></button>${btnSettings}</div>`;
            } else if (currentView === 'report') {
                exportBtns = `<div class="flex bg-white rounded-lg shadow-sm border border-gray-200 p-1"><button onclick="exportReportXLSX()" class="px-3 py-1.5 text-gray-500 hover:text-emerald-600 rounded"><i class="fa-solid fa-file-excel text-lg"></i></button><div class="w-px bg-gray-200 my-1"></div><button onclick="exportReportPDF()" class="px-3 py-1.5 text-gray-500 hover:text-red-600 rounded"><i class="fa-solid fa-file-pdf text-lg"></i></button>${btnSettings}</div>`;
            } else if (currentView === 'users') {
                exportBtns = `<div class="flex bg-white rounded-lg shadow-sm border border-gray-200 p-1"><button onclick="exportUsersPDF()" class="px-3 py-1.5 text-gray-500 hover:text-red-600 rounded"><i class="fa-solid fa-file-pdf text-lg"></i></button>${btnSettings}</div>`;
            } else if (currentView === 'items') {
                exportBtns = `<div class="flex bg-white rounded-lg shadow-sm border border-gray-200 p-1"><button onclick="exportItemsXLSX()" class="px-3 py-1.5 text-gray-500 hover:text-emerald-600 rounded"><i class="fa-solid fa-file-excel text-lg"></i></button><div class="w-px bg-gray-200 my-1"></div><button onclick="exportItemsPDF()" class="px-3 py-1.5 text-gray-500 hover:text-red-600 rounded"><i class="fa-solid fa-file-pdf text-lg"></i></button>${btnSettings}</div>`;
            } else if (currentView === 'status') {
                exportBtns = `<div class="flex bg-white rounded-lg shadow-sm border border-gray-200 p-1"><button onclick="exportStatusXLSX()" class="px-3 py-1.5 text-gray-500 hover:text-emerald-600 rounded"><i class="fa-solid fa-file-excel text-lg"></i></button><div class="w-px bg-gray-200 my-1"></div><button onclick="exportStatusPDF()" class="px-3 py-1.5 text-gray-500 hover:text-red-600 rounded"><i class="fa-solid fa-file-pdf text-lg"></i></button></div>`;
            }

            let topHtml = `<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><div class="flex items-center"><input type="text" oninput="handleSearch(this.value)" value="${searchTerm}" placeholder="ค้นหา..." class="p-2 border rounded text-sm w-40">${pg}</div><div class="flex gap-2 flex-wrap justify-end">${exportBtns}</div></div>`;
            
            if(currentView === 'items' && canAct) {
                topHtml = `<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><div class="flex flex-wrap items-center gap-3 justify-end"><div class="flex items-center"><input type="text" oninput="handleSearch(this.value)" value="${searchTerm}" placeholder="ค้นหา..." class="p-2 border rounded text-sm w-40">${pg}</div>${exportBtns}<div class="flex bg-white rounded-lg shadow-sm border border-gray-200 p-1"><button onclick="syncExternalData()" class="flex items-center gap-2 px-3 py-1.5 text-sm text-gray-600 hover:text-orange-600 hover:bg-orange-50 rounded transition-colors" title="อัปเดตข้อมูล"><i class="fa-solid fa-rotate"></i> <span class="hidden sm:inline">อัปเดต</span></button><div class="w-px bg-gray-200 my-1"></div><button onclick="downloadTemplate()" class="flex items-center gap-2 px-3 py-1.5 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors" title="ดาวน์โหลดฟอร์ม"><i class="fa-solid fa-file-arrow-down"></i> <span class="hidden sm:inline">โหลดฟอร์ม</span></button><div class="w-px bg-gray-200 my-1"></div><div class="relative"><button class="flex items-center gap-2 px-3 py-1.5 text-sm text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors"><i class="fa-solid fa-file-import"></i> <span class="hidden sm:inline">นำเข้า</span></button><input type="file" id="import-file" accept=".xlsx, .xls" onchange="handleImport(this)" class="absolute inset-0 opacity-0 cursor-pointer" title="อัปโหลดไฟล์ Excel"></div></div><button onclick="openItemModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center gap-2 text-sm font-medium"><i class="fa-solid fa-plus"></i> <span>เพิ่มข้อมูล</span></button><button onclick="deleteSelected('item')" id="btn-delete-items" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition-all hidden flex items-center gap-2 text-sm font-medium animate-pulse"><i class="fa-solid fa-trash-can"></i> <span id="selected-count">0</span></button></div></div>`;
            } else if (currentView === 'users') {
                topHtml = `<div class="flex justify-end mb-4 gap-2">${exportBtns}</div>`;
            } else if (currentView === 'profile') {
                const uName = currentUser && currentUser.name ? currentUser.name : '';
                const uGroup = currentUser && currentUser.group ? currentUser.group : '';
                topHtml = `<div class="bg-white max-w-lg p-6 rounded-xl shadow-sm"><form onsubmit="handleProfileUpdate(event)" class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Username (แก้ไขไม่ได้)</label><input type="text" value="${currentUser.username}" disabled class="w-full p-2 bg-gray-100 border rounded-lg text-gray-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล</label><input type="text" id="edit-name" value="${uName}" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">กลุ่มงาน</label><select id="edit-group" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500">${DEPARTMENTS.map(g => `<option value="${g}" ${uGroup === g ? 'selected' : ''}>${g}</option>`).join('')}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่านใหม่ (ว่างไว้ถ้าไม่เปลี่ยน)</label><input type="password" id="edit-pass" placeholder="เปลี่ยนรหัสผ่าน" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500"></div><button type="submit" class="btn-primary w-full">บันทึก</button></form></div>`;
            } else if (currentView !== 'borrow') {
                let deleteBtnId = '';
                if(currentView === 'history') deleteBtnId = 'btn-delete-history';
                else if(currentView === 'dispose') deleteBtnId = 'btn-delete-dispose';
                else if(currentView === 'return_customer') deleteBtnId = 'btn-delete-return';

                topHtml = `<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><div class="flex items-center"><input type="text" oninput="handleSearch(this.value)" value="${searchTerm}" placeholder="ค้นหา..." class="p-2 border rounded text-sm w-40">${pg}</div><div class="flex gap-2 flex-wrap justify-end">${(isAdmin && deleteBtnId) ? `<button onclick="deleteSelected('event')" id="${deleteBtnId}" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md hidden flex items-center gap-2 text-sm font-medium animate-pulse"><i class="fa-solid fa-trash-can"></i> ลบที่เลือก</button>` : ''}${exportBtns}</div></div>`;
            }

            if(currentView !== 'profile') topHtml += `<div class="bg-white rounded-xl shadow-sm overflow-hidden"><div class="overflow-x-auto"><table id="main-table" class="w-full text-left text-sm"><thead class="bg-gray-50 text-gray-600 font-semibold border-b"></thead><tbody class="divide-y divide-gray-100" id="data-body"></tbody></table></div><div id="pagination-controls"></div></div>`;
            
            if(currentView === 'borrow') {
                container.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-xl shadow-sm h-[600px] flex flex-col"><h3 class="text-lg font-bold mb-4 text-emerald-700 border-b pb-2">เบิกตัวอย่าง (ค้นหา)</h3><div class="mb-4"><input type="text" oninput="handleSearch(this.value)" value="${searchTerm}" placeholder="พิมพ์เลขรับ..." class="w-full p-2 border rounded-lg"></div><div class="flex-1 overflow-y-auto pr-2"><table class="w-full text-sm text-left"><thead><tr><th class="pb-2">เลขรับ</th><th class="pb-2">จำนวน</th><th class="pb-2">ชั้น</th><th class="pb-2 text-right">เลือก</th></tr></thead><tbody id="borrow-list-body"></tbody></table></div></div><div class="bg-white p-6 rounded-xl shadow-sm h-fit"><h3 class="text-lg font-bold mb-4 text-blue-700 border-b pb-2">คืนตัวอย่าง</h3><div class="overflow-y-auto max-h-[500px]"><table class="w-full text-sm text-left"><thead><tr><th class="pb-2">เลขรับ</th><th class="pb-2">จำนวน</th><th class="pb-2 text-right">คืน</th></tr></thead><tbody id="return-list-body"></tbody></table></div></div></div>`;
            } else {
                container.innerHTML = topHtml;
            }

            if(currentView !== 'profile' && currentView !== 'borrow') {
                const thead = document.querySelector('thead');
                if(thead) {
                    let headerHTML = '';
                    if(currentView==='status') headerHTML = `<tr><th class="p-4">เลขรับ</th><th class="p-4">จำนวน</th><th class="p-4">ชั้นเก็บ</th><th class="p-4">สถานะ</th><th class="p-4">ผู้เบิก</th><th class="p-4">พารามิเตอร์</th><th class="p-4">รายงานผล</th></tr>`;
                    else if(currentView==='items') headerHTML = `<tr><th class="p-4 w-10">${canAct?'<input type="checkbox" onchange="toggleAllItems(this,\'btn-delete-items\')">':''}</th><th class="p-4">เลขรับ</th><th class="p-4">จำนวน</th><th class="p-4">ชั้นเก็บ</th><th class="p-4">วันที่รับ</th><th class="p-4">การจำหน่าย</th><th class="p-4">จัดการ</th></tr>`;
                    else if(currentView==='report') headerHTML = `<tr><th class="p-4">เลขรับ</th><th class="p-4">วันที่รับ</th><th class="p-4">พารามิเตอร์</th><th class="p-4 text-center">จัดการ</th></tr>`;
                    else if(currentView==='history') headerHTML = `<tr><th class="p-4 w-10">${isAdmin?'<input type="checkbox" onchange="toggleAllItems(this,\'btn-delete-history\')">':''}</th><th class="p-4">เวลา</th><th class="p-4">รายการ</th><th class="p-4">เลขรับ</th><th class="p-4">ผู้ทำ</th><th class="p-4">ชื่อ</th><th class="p-4">กลุ่ม</th><th class="p-4">หมายเหตุ</th><th class="p-4">จัดการ</th></tr>`;
                    else if(currentView==='users') headerHTML = `<tr><th class="p-4">Username</th><th class="p-4">ชื่อ</th><th class="p-4">กลุ่ม</th><th class="p-4">สถานะ</th><th class="p-4 text-center">สิทธิ์รายงาน</th><th class="p-4 text-center">สิทธิ์จัดการ</th><th class="p-4 text-center">สิทธิ์จำหน่าย</th><th class="p-4 text-center">จัดการ</th></tr>`;
                    else if(currentView.includes('dispose') || currentView==='return_customer') headerHTML = `<tr><th class="p-4">เลขรับ</th><th class="p-4">จำนวน</th><th class="p-4">ชั้นเก็บ</th><th class="p-4">รายงานผล</th><th class="p-4">เกินกำหนด</th><th class="p-4 text-center">จัดการ</th></tr>`;
                    thead.innerHTML = headerHTML;
                }
                updateTableData();
            } else if(currentView === 'borrow') {
                updateTableData();
            }
        }

        function updateTableData() {
            const tbody = document.getElementById('data-body');
            const borrowBody = document.getElementById('borrow-list-body');
            const returnBody = document.getElementById('return-list-body');
            const pagination = document.getElementById('pagination-controls');

            if (currentView === 'borrow') {
                const availableItems = items.filter(i => i.status === 'Available');
                const borrowedByMe = items.filter(i => i.status === 'Borrowed' && i.holder === currentUser.username);
                const filteredAvailable = availableItems.filter(i => !searchTerm || (i.receiptNo||"").toLowerCase().includes(searchTerm));
                if(borrowBody) borrowBody.innerHTML = filteredAvailable.length===0?'<tr><td colspan="4" class="text-center py-4 text-gray-400">ไม่พบตัวอย่าง</td></tr>':filteredAvailable.map(i=>`<tr class="hover:bg-gray-50"><td class="py-3 font-bold text-gray-700">${i.receiptNo}</td><td class="py-3">${i.qty}</td><td class="py-3 text-gray-500">${i.layer}</td><td class="py-3 text-right"><button onclick="processTransaction('borrow','${i.id}')" class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded text-xs font-bold">เบิก</button></td></tr>`).join('');
                if(returnBody) returnBody.innerHTML = borrowedByMe.length===0?'<tr><td colspan="3" class="text-center py-4 text-gray-400">ไม่มีรายการ</td></tr>':borrowedByMe.map(i=>`<tr class="hover:bg-gray-50"><td class="py-3 font-bold">${i.receiptNo}</td><td class="py-3">${i.qty}</td><td class="py-3 text-right"><button onclick="processTransaction('return','${i.id}')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs font-bold">คืน</button></td></tr>`).join('');
                return;
            }

            if(!tbody) return;

            let filtered = items;
            const canAct = currentUser.username === 'admin' || (currentView === 'items' && currentUser.canManage) || (currentView === 'report' && currentUser.canReport) || ((currentView === 'dispose' || currentView === 'return_customer') && currentUser.canDispose);
            const isAdmin = currentUser.username === 'admin';

            if(currentView === 'report') filtered = items.filter(i => !i.dateReported);
            else if(currentView === 'dispose') filtered = items.filter(i => i.dateReported && i.disposalStatus !== 'Completed' && calculateDaysRemaining(i.dateReported) >= 60 && i.disposalPref !== 'รับคืน');
            else if(currentView === 'return_customer') filtered = items.filter(i => i.dateReported && i.disposalStatus !== 'Completed' && calculateDaysRemaining(i.dateReported) >= 60 && i.disposalPref === 'รับคืน');
            else if(currentView === 'history') filtered = events;
            else if(currentView === 'users') filtered = userList;

            const s = searchTerm.toLowerCase();
            filtered = filtered.filter(row => {
                if(!s) return true;
                if(currentView === 'users') return row.username.toLowerCase().includes(s) || row.name.toLowerCase().includes(s);
                if(currentView === 'history') return (row.itemName||"").toLowerCase().includes(s) || (row.user||"").toLowerCase().includes(s);
                return (row.receiptNo||"").toLowerCase().includes(s);
            });

            const total = filtered.length;
            const start = (currentPage - 1) * rowsPerPage;
            const end = rowsPerPage === 10000 ? total : start + rowsPerPage;
            const paged = filtered.slice(start, end);

            tbody.innerHTML = paged.map(row => {
                if(currentView === 'users') {
                    return `<tr class="hover:bg-gray-50"><td class="p-4 font-bold">${row.username}</td><td class="p-4">${row.name}</td><td class="p-4 text-gray-500">${row.group}</td><td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-bold ${row.status==='Approved'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${row.status}</span></td><td class="p-4 text-center"><input type="checkbox" ${row.canReport?'checked':''} onchange="toggleUserPermission('${row.username}','report',this.checked)"></td><td class="p-4 text-center"><input type="checkbox" ${row.canManage?'checked':''} onchange="toggleUserPermission('${row.username}','manage',this.checked)"></td><td class="p-4 text-center"><input type="checkbox" ${row.canDispose?'checked':''} onchange="toggleUserPermission('${row.username}','dispose',this.checked)"></td><td class="p-4 text-center">${row.status==='Pending'?`<button onclick="approveUser('${row.username}')" class="bg-emerald-100 text-emerald-700 px-2 rounded">✔</button>`:''}<button onclick="deleteUser('${row.username}')" class="text-red-500 ml-2"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                }
                if(currentView === 'history') {
                    const u = getUserInfo(row.user);
                    return `<tr class="hover:bg-gray-50"><td class="p-4">${isAdmin?`<input type="checkbox" class="item-checkbox" value="${row.id}" onchange="checkSelection('btn-delete-history')">`:''}</td><td class="p-4">${formatDateTh(row.date)}</td><td class="p-4"><span class="px-2 py-1 rounded-full text-xs ${row.type==='Borrow'?'bg-orange-100 text-orange-700':'bg-green-100 text-green-700'}">${row.type}</span></td><td class="p-4 font-mono">${row.itemName}</td><td class="p-4">${row.user}</td><td class="p-4">${u.name}</td><td class="p-4">${u.group}</td><td class="p-4 text-gray-400">${row.note||'-'}</td><td class="p-4">${isAdmin?`<button onclick="deleteEvent('${row.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button>`:''}</td></tr>`;
                }

                let cols = '';
                let acts = '';
                if(currentView === 'status') {
                    cols = `<td class="p-4 font-bold">${row.receiptNo}</td><td class="p-4">${row.qty}</td><td class="p-4">${row.layer}</td><td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-bold ${row.status==='Available'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${row.status}</span></td><td class="p-4">${row.holder}</td><td class="p-4 text-xs">${row.params}</td><td class="p-4 text-xs text-blue-500">${formatDateTh(row.dateReported,false)}</td>`;
                } else {
                    const chkId = currentView==='return_customer' ? 'btn-delete-return' : 'btn-delete-'+currentView;
                    const chk = (currentView === 'items' && canAct) ? `<input type="checkbox" class="item-checkbox" value="${row.id}" onchange="checkSelection('btn-delete-items')">` : '';
                    
                    if(currentView === 'items') {
                        cols = `<td class="p-4">${chk}</td><td class="p-4 font-bold">${row.receiptNo}</td><td class="p-4">${row.qty}</td><td class="p-4">${row.layer}</td><td class="p-4">${formatDateTh(row.dateReceived,false)}</td><td class="p-4 text-xs">${row.disposalPref}</td>`;
                        if(canAct) acts = `<button onclick='openItemModal(${JSON.stringify(row)})' class="text-blue-500 mr-2"><i class="fa-solid fa-edit"></i></button><button onclick="deleteItem('${row.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button>`;
                    } else if(currentView === 'report') {
                        cols = `<td class="p-4 font-bold">${row.receiptNo}</td><td class="p-4">${formatDateTh(row.dateReceived,false)}</td><td class="p-4 text-xs">${row.params}</td>`;
                        if(canAct) acts = `<button onclick="openReportDateModal('${row.id}','${row.receiptNo}')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs">ยืนยัน</button>`;
                    } else { 
                        const days = calculateDaysRemaining(row.dateReported);
                        cols = `<td class="p-4 font-bold">${row.receiptNo}</td><td class="p-4">${row.qty}</td><td class="p-4">${row.layer}</td><td class="p-4">${formatDateTh(row.dateReported,false)}</td><td class="p-4 text-red-600 font-bold">${days} วัน</td>`;
                        if(canAct) acts = `<button onclick="handleDisposeItem('${row.id}','${row.disposalPref}')" class="bg-orange-600 text-white px-2 py-1 rounded text-xs">ดำเนินการ</button>`;
                    }
                }
                
                return `<tr class="hover:bg-gray-50">${cols}${acts?`<td class="p-4 text-center">${acts}</td>`:''}</tr>`;
            }).join('');
            
            if(pagination) pagination.innerHTML = renderPagination(total, 'changePage');
        }

        async function approveUser(username) { if(!confirm('ยืนยันอนุมัติ?')) return; const res = await apiCall('approveUser', { username: username }); if(res.status === 'success') { alert('เรียบร้อย'); router('users'); } else { alert(res.message); } }
        async function toggleUserPermission(username, type, isChecked) { const res = await apiCall('toggleUserPermission', { username: username, type: type, value: isChecked }); if(res.status !== 'success') { alert(res.message); router('users'); } }
        async function deleteUser(username) { if(!confirm('ยืนยันลบ?')) return; const res = await apiCall('deleteUser', { username: username }); if(res.status === 'success') { router('users'); } else { alert(res.message); } }
        function openReportDateModal(id, receiptNo) { const today = new Date().toISOString().split('T')[0]; document.getElementById('modal-container').innerHTML = `<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 animate-[fadeIn_0.2s_ease-out]"><h3 class="text-xl font-bold mb-4 text-blue-700">ยืนยันการรายงานผล</h3><p class="text-sm text-gray-600 mb-4">เลขรับ: <b>${receiptNo}</b></p><div class="mb-4"><label class="block text-sm font-bold text-gray-700 mb-1">เลือกวันที่</label><input type="date" id="report-date-picker" value="${today}" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></div><div class="flex justify-end space-x-2 border-t pt-4"><button onclick="document.getElementById('modal-container').innerHTML=''" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">ยกเลิก</button><button onclick="confirmReport('${id}')" class="btn-primary bg-blue-600 hover:bg-blue-700">ยืนยัน</button></div></div></div>`; }
        async function confirmReport(id) { const date = document.getElementById('report-date-picker').value; if(!date) return alert("กรุณาเลือกวันที่"); document.getElementById('modal-container').innerHTML = ''; const res = await apiCall('reportItem', { id: id, date: date }); if(res.status === 'success') { alert('เรียบร้อย'); await refreshData(); router('report'); } else { alert(res.message); } }
        async function handleDisposeItem(id, pref) { if(!confirm(`ยืนยันการดำเนินการ (${pref === 'รับคืน' ? 'คืนเจ้าของ' : 'ทิ้ง'})?`)) return; const res = await apiCall('disposeItem', { id: id }); if(res.status === 'success') { alert('เรียบร้อย'); await refreshData(); router(currentView); } else { alert(res.message); } }
        async function deleteItem(id) { if (!confirm('ยืนยันที่จะลบรายการนี้?')) return; const res = await apiCall('deleteItem', { id }); if (res.status === 'success') { await refreshData(); router(currentView); } }
        async function deleteEvent(id) { if (!confirm('ยืนยันที่จะลบประวัตินี้?')) return; const res = await apiCall('deleteEvent', { id }); if (res.status === 'success') { await refreshData(); router('history'); } }
        function toggleAllItems(source, btnId) { 
            const checkboxes = document.querySelectorAll('.item-checkbox'); 
            checkboxes.forEach(cb => cb.checked = source.checked); 
            checkSelection(btnId); 
        }
        function checkSelection(btnId) { 
            const checkedCount = document.querySelectorAll('.item-checkbox:checked').length; 
            const btn = document.getElementById(btnId); 
            if(btn) { 
                if(checkedCount > 0) { btn.classList.remove('hidden'); btn.querySelector('span') ? btn.querySelector('span').textContent = checkedCount : null; }
                else btn.classList.add('hidden'); 
            } 
        }
        async function deleteSelected(type) {
            const checked = document.querySelectorAll('.item-checkbox:checked');
            if(checked.length === 0) return;
            if(!confirm(`ยืนยันการลบ ${checked.length} รายการ?`)) return;
            showLoading(`กำลังลบ...`);
            for(let cb of checked) {
                if(type === 'event') await apiCall('deleteEvent', { id: cb.value }, false);
                else await apiCall('deleteItem', { id: cb.value }, false);
            }
            hideLoading();
            await refreshData();
            router(currentView);
        }
        // ... (Remaining helper functions from previous code block) ...
