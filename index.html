<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบจัดการสต๊อกวัสดุ Test Kit - กลุ่มวิจัยเคมีดิน</title>
  
  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- jspdf & autotable (New PDF Solution) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
    .hidden { display: none !important; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

  <!-- NOTIFICATIONS & OVERLAYS -->
  <div id="toast" class="fixed top-5 right-5 z-[60] hidden p-4 rounded shadow-lg text-white transform transition-all duration-300 translate-y-0"></div>
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex flex-col items-center justify-center text-white">
    <div class="loader mb-3"></div>
    <p class="font-medium animate-pulse" id="loadingText">กำลังประมวลผลข้อมูล...</p>
  </div>

  <!-- CAMERA UI -->
  <div id="cameraModal" class="fixed inset-0 bg-black z-[90] hidden flex flex-col">
    <div class="relative flex-1 bg-black flex items-center justify-center overflow-hidden">
      <video id="cameraVideo" autoplay playsinline class="absolute inset-0 w-full h-full object-cover"></video>
      <canvas id="cameraCanvas" class="hidden"></canvas>
    </div>
    <div class="h-32 bg-black/80 flex items-center justify-around px-8 pb-6 pt-4">
      <button onclick="closeCamera()" class="p-4 rounded-full bg-gray-800/80 text-white hover:bg-gray-700 transition"><i class="fas fa-times text-xl"></i></button>
      <button onclick="capturePhoto()" class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center hover:bg-gray-800 transition active:scale-95"><div class="w-16 h-16 bg-white rounded-full"></div></button>
      <button onclick="switchCamera()" class="p-4 rounded-full bg-gray-800/80 text-white hover:bg-gray-700 transition"><i class="fas fa-sync-alt text-xl"></i></button>
    </div>
  </div>

  <!-- AUTHENTICATION -->
  <div id="authPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-900 to-slate-800 p-4 absolute inset-0 z-50 overflow-y-auto">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border-t-4 border-indigo-500">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-slate-800">กลุ่มวิจัยเคมีดิน</h1>
        <p class="text-slate-500 text-sm mt-1">ระบบบริหารจัดการวัสดุ Test Kit</p>
      </div>
      <form id="loginForm" class="space-y-4">
        <input type="text" id="loginUser" class="w-full border p-2 rounded-lg" placeholder="Username" required>
        <input type="password" id="loginPass" class="w-full border p-2 rounded-lg" placeholder="Password" required>
        <button type="submit" class="w-full bg-indigo-600 text-white p-2.5 rounded-lg hover:bg-indigo-700 font-bold">เข้าสู่ระบบ</button>
        <div class="text-center mt-4 text-sm text-indigo-600 cursor-pointer" onclick="toggleAuth('register')">ลงทะเบียนใช้งาน</div>
      </form>
      <form id="registerForm" class="hidden space-y-3">
        <input type="text" id="regUser" class="w-full border p-2 rounded-lg" placeholder="Username" required>
        <input type="password" id="regPass" class="w-full border p-2 rounded-lg" placeholder="Password" required>
        <input type="text" id="regName" class="w-full border p-2 rounded-lg" placeholder="ชื่อ-นามสกุล" required>
        <input type="text" id="regGroup" class="w-full border p-2 rounded-lg" placeholder="กลุ่มงาน" required>
        <button type="submit" class="w-full bg-emerald-600 text-white p-2.5 rounded-lg hover:bg-emerald-700 font-bold">สมัครสมาชิก</button>
        <div class="text-center mt-3 text-sm text-slate-500 cursor-pointer" onclick="toggleAuth('login')">กลับไปหน้าเข้าสู่ระบบ</div>
      </form>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="mainApp" class="hidden flex h-full">
    <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl z-20 transition-all duration-300" id="sidebar">
      <div class="p-6 border-b border-slate-700">
        <h2 class="text-lg font-bold text-white">Test Kit Stock</h2>
        <p class="text-[10px] text-slate-400">Inventory System v2.4</p>
      </div>
      <nav class="flex-1 overflow-y-auto py-4 px-2 space-y-1">
        <a href="#" onclick="route('dashboard')" class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-slate-800 transition" data-page="dashboard"><i class="fas fa-chart-pie w-6"></i> <span>ภาพรวม</span></a>
        <a href="#" onclick="route('inventory')" class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-slate-800 transition" data-page="inventory"><i class="fas fa-boxes w-6"></i> <span>รายการวัสดุ</span></a>
        <a href="#" onclick="route('withdraw')" class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-slate-800 transition" data-page="withdraw"><i class="fas fa-hand-holding-box w-6"></i> <span>เบิกวัสดุ</span></a>
        <a href="#" onclick="route('import')" class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-slate-800 transition" data-page="import"><i class="fas fa-truck-loading w-6"></i> <span>นำเข้าสต๊อก</span></a>
        <a href="#" onclick="route('reports')" class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-slate-800 transition" data-page="reports"><i class="fas fa-file-alt w-6"></i> <span>รายงาน & ประวัติ</span></a>
        <div id="adminMenuSection" class="hidden">
          <a href="#" onclick="route('users')" class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-slate-800 transition" data-page="users"><i class="fas fa-users-cog w-6"></i> <span>จัดการผู้ใช้</span></a>
        </div>
      </nav>
      <div class="p-4 border-t border-slate-700 bg-slate-950/50 flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold" id="avatarInitials">U</div>
        <div class="flex-1 min-w-0"><p class="text-sm font-medium text-white truncate" id="sidebarName">Name</p><p class="text-xs text-slate-400" id="sidebarRole">Role</p></div>
        <button onclick="logout()" class="text-slate-400 hover:text-red-400"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </aside>

    <div class="flex-1 flex flex-col min-w-0 bg-gray-50">
      <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 z-10">
        <button class="md:hidden" onclick="document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebar').classList.toggle('absolute'); document.getElementById('sidebar').classList.toggle('h-full');"><i class="fas fa-bars"></i></button>
        <h2 class="text-xl font-bold text-slate-800" id="pageTitle">ภาพรวม</h2>
        <div class="flex items-center gap-2"><span class="text-sm text-slate-600 hidden md:block" id="headerGroupName">กลุ่มงาน</span></div>
      </header>
      <main class="flex-1 overflow-y-auto p-6 relative" id="contentArea"></main>
    </div>
  </div>

  <!-- MODAL: ADD MATERIAL -->
  <div id="materialModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[70] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-lg shadow-2xl">
      <div class="p-5 border-b flex justify-between"><h3 class="text-lg font-bold">จัดการวัสดุ</h3><button onclick="closeModal('materialModal')"><i class="fas fa-times"></i></button></div>
      <form id="materialForm" class="p-5">
        <input type="hidden" id="matId">
        <div class="mb-4"><label class="block text-sm font-medium mb-1">ชื่อวัสดุ</label><input type="text" id="matName" class="w-full border p-2 rounded-lg" required></div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">รูปภาพ</label>
          <div class="flex gap-2 mb-2">
            <button type="button" onclick="toggleImgInput('file', 'mat')" class="px-3 py-1 bg-gray-200 rounded text-xs">ไฟล์</button>
            <button type="button" onclick="toggleImgInput('url', 'mat')" class="px-3 py-1 bg-gray-200 rounded text-xs">Link</button>
            <button type="button" onclick="openCamera('mat')" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-xs"><i class="fas fa-camera"></i> ถ่ายรูป</button>
          </div>
          <div id="matInputFile" class="border-2 border-dashed rounded-lg p-4 text-center cursor-pointer relative h-32 flex items-center justify-center">
            <input type="file" id="matImgFile" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewImage(this, 'mat')">
            <div id="matPreview" class="hidden absolute inset-0 bg-contain bg-center bg-no-repeat bg-white"></div>
            <div id="matPlaceholder" class="text-gray-400 text-sm">คลิกเพื่อเลือกไฟล์</div>
          </div>
          <input type="url" id="matImgUrl" class="hidden w-full border p-2 rounded-lg" placeholder="https://...">
        </div>
        <div class="flex justify-end gap-2"><button type="button" onclick="closeModal('materialModal')" class="px-4 py-2 bg-gray-100 rounded">ยกเลิก</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">บันทึก</button></div>
      </form>
    </div>
  </div>

  <!-- MODAL: TRANSACTION -->
  <div id="transModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[70] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-5 border-b bg-gray-50 flex justify-between"><h3 id="transModalTitle" class="text-lg font-bold">ทำรายการ</h3><button onclick="closeModal('transModal')"><i class="fas fa-times"></i></button></div>
      <form id="transForm" class="p-6">
        <input type="hidden" id="transType"><input type="hidden" id="transMatId"><input type="hidden" id="transMatName">
        <div class="flex items-center gap-3 mb-4">
          <img id="transImgPreview" class="w-16 h-16 object-cover rounded bg-gray-200">
          <div><p class="font-bold text-lg line-clamp-1" id="transMatNameDisplay">Material</p><p class="text-sm text-gray-500">คงเหลือ: <span id="transCurrentQty">0</span></p></div>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">จำนวน</label>
          <div class="flex items-center"><button type="button" onclick="adjQty(-1)" class="w-10 h-10 border rounded-l">-</button><input type="number" id="transQty" class="w-full h-10 border-y text-center" min="1" value="1" required><button type="button" onclick="adjQty(1)" class="w-10 h-10 border rounded-r">+</button></div>
        </div>
        <div id="importFields" class="hidden mb-4 space-y-3 p-3 bg-blue-50 rounded border border-blue-100">
          <div><label class="block text-sm font-medium text-blue-800">วันที่ (ย้อนหลังได้)</label><input type="date" id="transDate" class="w-full border p-2 rounded"></div>
          <div><label class="block text-sm font-medium text-blue-800">อ้างอิงเอกสาร</label><input type="text" id="transRef" class="w-full border p-2 rounded"></div>
        </div>
        
        <!-- Transaction Photo Proof -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2 text-gray-700">รูปภาพยืนยัน (ไม่บังคับ)</label>
          <div class="flex gap-2 mb-2">
            <button type="button" onclick="toggleImgInput('file', 'trans')" class="px-3 py-1 bg-gray-200 rounded text-xs">ไฟล์</button>
            <button type="button" onclick="openCamera('trans')" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-xs"><i class="fas fa-camera"></i> ถ่ายรูป</button>
          </div>
          <div id="transInputFile" class="border-2 border-dashed rounded-lg p-2 text-center cursor-pointer relative h-24 flex items-center justify-center bg-gray-50">
            <input type="file" id="transProofFile" accept="image/*" class="absolute inset-0 w-full h-full opacity-0" onchange="previewImage(this, 'trans')">
            <div id="transPreview" class="hidden absolute inset-0 bg-contain bg-center bg-no-repeat bg-white"></div>
            <div id="transPlaceholder" class="text-gray-400 text-xs">คลิกเพื่อแนบรูป</div>
          </div>
        </div>

        <button type="submit" id="btnTransSubmit" class="w-full py-3 rounded-lg font-bold text-white shadow-md">ยืนยัน</button>
      </form>
    </div>
  </div>

  <!-- MODAL: UPLOAD PROOF LATER -->
  <div id="proofModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[80] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-sm shadow-2xl">
      <div class="p-4 border-b flex justify-between"><h3 class="font-bold">แนบรูปย้อนหลัง</h3><button onclick="closeModal('proofModal')"><i class="fas fa-times"></i></button></div>
      <form id="proofForm" class="p-4">
        <input type="hidden" id="proofTxId"><input type="hidden" id="proofType">
        <div class="mb-4">
          <div class="flex gap-2 mb-2 justify-center"><button type="button" onclick="openCamera('proof')" class="px-4 py-2 bg-indigo-600 text-white rounded-full shadow"><i class="fas fa-camera"></i> ถ่ายรูป</button></div>
          <div class="border-2 border-dashed rounded-lg p-2 relative h-40 flex items-center justify-center bg-gray-50">
            <input type="file" id="proofFile" accept="image/*" class="absolute inset-0 w-full h-full opacity-0" onchange="previewImage(this, 'proof')">
            <div id="proofPreview" class="hidden absolute inset-0 bg-contain bg-center bg-no-repeat bg-white"></div>
            <div id="proofPlaceholder" class="text-gray-400 text-sm">หรือคลิกเลือกไฟล์</div>
          </div>
        </div>
        <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded font-bold">อัปโหลด</button>
      </form>
    </div>
  </div>

  <!-- MODAL: USER PERMISSIONS -->
  <div id="userPermModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[80] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-md shadow-2xl">
      <div class="p-4 border-b flex justify-between items-center"><h3 class="font-bold text-lg">กำหนดสิทธิ์ผู้ใช้งาน</h3><button onclick="closeModal('userPermModal')"><i class="fas fa-times"></i></button></div>
      <div class="p-6">
        <div class="flex items-center gap-3 mb-4 p-3 bg-blue-50 rounded-lg">
          <div class="w-10 h-10 bg-blue-200 rounded-full flex items-center justify-center text-blue-700 font-bold" id="permUserInitials">U</div>
          <div><h4 class="font-bold text-gray-800" id="permUserName">User</h4><p class="text-xs text-gray-500" id="permUserGroup">Group</p></div>
        </div>
        <input type="hidden" id="permUserId">
        <div class="space-y-2">
          <label class="flex items-center justify-between p-3 border rounded hover:bg-gray-50 cursor-pointer"><span class="text-sm font-medium">ดูข้อมูล (View)</span><input type="checkbox" id="perm_view_stock" checked disabled class="accent-blue-600 w-5 h-5"></label>
          <label class="flex items-center justify-between p-3 border rounded hover:bg-gray-50 cursor-pointer"><span class="text-sm font-medium">เบิกวัสดุ (Withdraw)</span><input type="checkbox" id="perm_withdraw_material" class="accent-blue-600 w-5 h-5"></label>
          <label class="flex items-center justify-between p-3 border rounded hover:bg-gray-50 cursor-pointer"><span class="text-sm font-medium">นำเข้าสต๊อก (Import)</span><input type="checkbox" id="perm_import_material" class="accent-blue-600 w-5 h-5"></label>
          <label class="flex items-center justify-between p-3 border rounded hover:bg-gray-50 cursor-pointer"><span class="text-sm font-medium">จัดการรายการ (Manage)</span><input type="checkbox" id="perm_manage_material" class="accent-blue-600 w-5 h-5"></label>
        </div>
        <button onclick="savePermissions()" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold mt-4 hover:bg-blue-700 shadow">บันทึกสิทธิ์</button>
      </div>
    </div>
  </div>

  <!-- JS LOGIC -->
  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxdK7zgf3YLbUPUEEgBhfe2jP2g6J4jvgGLhNUJnTd4WGlL9OJUVL5wJFBI6iMV9d4o/exec";
    const state = { user: null, materials: [], reports: { withdraw: [], import: [] }, pagination: { currentPage: 1, itemsPerPage: 9, totalPages: 1 }, filter: { search: '', sort: 'newest' } };
    let stockChartInstance, statusChartInstance, videoStream, currentFacingMode = 'environment', currentCamTarget = '';
    const cache = { materials: null, users: null, reports: null };

    async function api(action, payload = {}) {
      const showOverlay = !['getMaterials', 'getReports'].includes(action); 
      if(showOverlay) document.getElementById('loadingOverlay').classList.remove('hidden');
      try {
        let result;
        if (typeof google !== 'undefined' && google.script) {
          result = await new Promise((resolve, reject) => google.script.run.withSuccessHandler(res => res.success ? resolve(res.data) : reject(new Error(res.error))).withFailureHandler(reject).apiHandler({ action, payload }));
        } else {
          const res = await fetch(WEB_APP_URL, { method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ action, payload }) });
          const json = await res.json();
          if(!json.success) throw new Error(json.error);
          result = json.data;
        }
        if(showOverlay) document.getElementById('loadingOverlay').classList.add('hidden');
        return result;
      } catch (err) {
        if(showOverlay) document.getElementById('loadingOverlay').classList.add('hidden');
        showToast(err.message, 'error');
        throw err;
      }
    }

    // AUTH
    function initApp() { 
      const u = localStorage.getItem('user_session'); 
      if (u) { state.user = JSON.parse(u); setupUI(); route('dashboard'); } else { document.getElementById('authPage').classList.remove('hidden'); } 
    }
    function setupUI() {
      document.getElementById('authPage').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('sidebarName').innerText = state.user.fullname.split(' ')[0]; document.getElementById('sidebarRole').innerText = state.user.role.toUpperCase();
      document.getElementById('avatarInitials').innerText = state.user.fullname.charAt(0);
      document.getElementById('adminMenuSection').classList.toggle('hidden', state.user.role !== 'admin');
    }
    document.getElementById('loginForm').onsubmit = async (e) => { e.preventDefault(); try { state.user = await api('login', { username: document.getElementById('loginUser').value, password: document.getElementById('loginPass').value }); localStorage.setItem('user_session', JSON.stringify(state.user)); setupUI(); route('dashboard'); } catch(e) {} };
    function logout() { localStorage.removeItem('user_session'); localStorage.removeItem('local_materials'); location.reload(); }
    function toggleAuth(mode) { document.getElementById('loginForm').classList.toggle('hidden', mode === 'register'); document.getElementById('registerForm').classList.toggle('hidden', mode !== 'register'); }

    // ROUTING
    async function route(page) {
      document.querySelectorAll('.nav-item').forEach(el => {
        el.classList.toggle('bg-slate-800', el.dataset.page === page);
        el.classList.toggle('text-white', el.dataset.page === page);
      });
      const c = document.getElementById('contentArea');
      if (stockChartInstance) { stockChartInstance.destroy(); stockChartInstance = null; }
      if (statusChartInstance) { statusChartInstance.destroy(); statusChartInstance = null; }

      switch(page) {
        case 'dashboard': renderDashboard(c); break;
        case 'inventory': renderInventory(c, 'view'); break;
        case 'withdraw': renderInventory(c, 'withdraw'); break;
        case 'import': renderInventory(c, 'import'); break;
        case 'reports': renderReports(c); break;
        case 'users': renderUsers(c); break;
      }
    }

    // DASHBOARD
    async function renderDashboard(c) {
      if(!c) return;
      c.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">${cardSkeleton().repeat(4)}</div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 h-64 bg-white rounded-xl shadow-sm border"></div><div class="h-64 bg-white rounded-xl shadow-sm border"></div></div>`;
      
      const cachedMat = localStorage.getItem('local_materials');
      if(cachedMat) { state.materials = JSON.parse(cachedMat); updateDashboardUI(c); }
      
      try {
        const freshData = await api('getMaterials');
        state.materials = freshData;
        localStorage.setItem('local_materials', JSON.stringify(freshData));
        updateDashboardUI(c);
      } catch(e) {}
    }
    
    function updateDashboardUI(c) {
        if(!c || !document.contains(c)) return;

        const total = state.materials.length, stock = state.materials.reduce((s, m) => s + parseInt(m.qty||0), 0), low = state.materials.filter(m => parseInt(m.qty||0)<5).length;
        const last = state.materials.length ? formatDate(state.materials[state.materials.length-1].last_import_date).split(' ')[0] : '-';
        
        c.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 fade-in">
            ${statCard('ทั้งหมด', total, 'fas fa-box', 'bg-blue-500')} ${statCard('คงเหลือรวม', stock, 'fas fa-layer-group', 'bg-emerald-500')}
            ${statCard('ใกล้หมด', low, 'fas fa-exclamation-triangle', 'bg-amber-500')} ${statCard('อัปเดตล่าสุด', last, 'fas fa-clock', 'bg-purple-500')}
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
            <div class="bg-white p-6 rounded-xl shadow-sm lg:col-span-2 border"><h3 class="font-bold mb-4">Top 10</h3><div class="relative h-64 w-full"><canvas id="stockChart"></canvas></div></div>
            <div class="bg-white p-6 rounded-xl shadow-sm border"><h3 class="font-bold mb-4">สถานะ</h3><div class="relative h-48 w-full"><canvas id="statusChart"></canvas></div></div>
          </div>`;
        const top = [...state.materials].sort((a,b)=>b.qty-a.qty).slice(0,10);
        
        if(stockChartInstance) stockChartInstance.destroy();
        if(statusChartInstance) statusChartInstance.destroy();
        
        const ctx1 = document.getElementById('stockChart');
        if(ctx1) {
          stockChartInstance = new Chart(ctx1, { type: 'bar', data: { labels: top.map(m=>m.name.substring(0,10)), datasets: [{ label: 'Qty', data: top.map(m=>m.qty), backgroundColor: '#6366f1' }] }, options: { responsive: true, maintainAspectRatio: false } });
        }
        
        const ctx2 = document.getElementById('statusChart');
        if(ctx2) {
          statusChartInstance = new Chart(ctx2, { type: 'doughnut', data: { labels: ['ปกติ', 'ต่ำ', 'หมด'], datasets: [{ data: [total-low-state.materials.filter(m=>m.qty==0).length, low, state.materials.filter(m=>m.qty==0).length], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'] }] }, options: { responsive: true, maintainAspectRatio: false } });
        }
    }

    // INVENTORY
    async function renderInventory(c, mode) {
      if(!c) return;
      const perms = state.user.permissions || [];
      const isAdmin = state.user.role === 'admin';
      
      if (mode === 'withdraw' && !isAdmin && !perms.includes('withdraw_material')) return c.innerHTML = '<div class="p-10 text-center text-gray-400">คุณไม่มีสิทธิ์เข้าถึงเมนูนี้</div>';
      if (mode === 'import' && !isAdmin && !perms.includes('import_material')) return c.innerHTML = '<div class="p-10 text-center text-gray-400">คุณไม่มีสิทธิ์เข้าถึงเมนูนี้</div>';
      const canManage = isAdmin || perms.includes('manage_material');

      c.innerHTML = `<div class="bg-white rounded-xl shadow-sm border flex flex-col h-full fade-in">
        <div class="p-4 border-b flex flex-col md:flex-row gap-4 justify-between items-center">
          <input type="text" id="searchInput" placeholder="ค้นหา..." class="w-full md:w-96 border p-2 rounded-lg" onkeyup="handleSearch('${mode}')">
          <div class="flex gap-2">
            ${mode==='view'&&canManage?`<button onclick="openMaterialModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">+ เพิ่ม</button>`:''}
            <select id="sortSelect" onchange="renderMaterialList('${mode}')" class="border p-2 rounded-lg"><option value="newest">ใหม่สุด</option><option value="qty_asc">น้อย-มาก</option></select>
          </div>
        </div>
        <div id="inventoryContainer" class="p-6 overflow-y-auto flex-1 bg-slate-50 min-h-[400px]"></div>
        <div class="p-4 border-t flex justify-between"><span id="pageInfo"></span><div id="paginationControls" class="flex gap-1"></div></div>
      </div>`;
      
      const cachedMat = localStorage.getItem('local_materials');
      if(cachedMat) {
         state.materials = JSON.parse(cachedMat);
         renderMaterialList(mode);
      }
      
      const freshData = await api('getMaterials');
      state.materials = freshData;
      localStorage.setItem('local_materials', JSON.stringify(freshData));
      renderMaterialList(mode);
    }

    function renderMaterialList(mode) {
      const container = document.getElementById('inventoryContainer');
      if (!container) return; 

      const searchInput = document.getElementById('searchInput');
      const txt = searchInput ? searchInput.value.toLowerCase() : '';
      const sortSelect = document.getElementById('sortSelect');
      const sort = sortSelect ? sortSelect.value : 'newest';
      
      let list = state.materials.filter(m=>m.name.toLowerCase().includes(txt));
      if(sort==='qty_asc') list.sort((a,b)=>a.qty-b.qty); else list.sort((a,b)=>b.material_id.localeCompare(a.material_id));
      
      const { currentPage, itemsPerPage } = state.pagination;
      const start = (currentPage-1)*itemsPerPage;
      const paginated = list.slice(start, start+itemsPerPage);
      state.pagination.totalPages = Math.ceil(list.length/itemsPerPage);
      
      const pageInfo = document.getElementById('pageInfo');
      if(pageInfo) pageInfo.innerText = `แสดง ${list.length?start+1:0}-${Math.min(start+itemsPerPage, list.length)} จาก ${list.length}`;
      
      const pagControls = document.getElementById('paginationControls');
      if(pagControls) renderPaginationControls(mode);
      
      if(!paginated.length) { container.innerHTML = '<p class="text-center text-gray-400 py-10">ไม่พบข้อมูล</p>'; return; }

      const isAdmin = state.user.role === 'admin';
      const perms = state.user.permissions || [];
      const canManage = isAdmin || perms.includes('manage_material');

      container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6">` + paginated.map(m => `
        <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition flex flex-col border overflow-hidden">
          <div class="h-40 bg-gray-100 relative"><img src="${m.image_url||'https://via.placeholder.com/300'}" class="w-full h-full object-cover"></div>
          <div class="p-4 flex-1"><h4 class="font-bold mb-1 line-clamp-1">${m.name}</h4><div class="flex justify-between items-end"><span class="text-xs text-gray-400">${formatDate(m.last_import_date||m.last_withdraw_date).split(' ')[0]}</span><span class="text-xl font-bold text-indigo-600">${m.qty}</span></div></div>
          ${mode==='view'&&canManage?`<div class="border-t p-2 flex gap-2"><button onclick='openMaterialModal(${JSON.stringify(m)})' class="flex-1 py-1 text-xs border rounded hover:bg-gray-100">แก้ไข</button><button onclick="deleteMaterial('${m.material_id}')" class="flex-1 py-1 text-xs border rounded text-red-500 hover:bg-red-50">ลบ</button></div>`:
            `<button onclick='openTransModal("${mode}",${JSON.stringify(m)})' class="w-full py-3 text-white font-bold ${mode==='import'?'bg-emerald-500':'bg-rose-500'}">${mode==='import'?'นำเข้า':'เบิกออก'}</button>`}
        </div>`).join('') + `</div>`;
    }

    // --- REPORTS ---
    async function renderReports(c) {
      if(!c) return;
      c.innerHTML = `<div class="flex flex-col md:flex-row justify-between mb-6 fade-in gap-4">
        <h2 class="text-2xl font-bold">รายงาน</h2>
        <div class="flex gap-2 items-center">
            <span class="text-sm font-bold">วันที่:</span>
            <input type="date" id="filterStartDate" class="border p-1 rounded text-sm" onchange="filterReports()">
            <span>-</span>
            <input type="date" id="filterEndDate" class="border p-1 rounded text-sm" onchange="filterReports()">
            <button onclick="exportCSV()" class="px-3 py-1 bg-slate-800 text-white rounded">CSV</button>
            <button onclick="exportPDF()" class="px-3 py-1 bg-red-600 text-white rounded">PDF</button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-180px)]">
        <div class="bg-white rounded-xl shadow-sm border flex flex-col"><div class="p-4 border-b bg-rose-50 font-bold text-rose-700">ประวัติการเบิก</div><div class="overflow-y-auto flex-1" id="withdrawLog"></div></div>
        <div class="bg-white rounded-xl shadow-sm border flex flex-col"><div class="p-4 border-b bg-emerald-50 font-bold text-emerald-700">ประวัติการนำเข้า</div><div class="overflow-y-auto flex-1" id="importLog"></div></div>
      </div>`;
      try {
        state.reports = await api('getReports');
        filterReports(); // Call filter initially
      } catch(e) {}
    }

    function filterReports() {
        const startEl = document.getElementById('filterStartDate');
        const endEl = document.getElementById('filterEndDate');
        if (!startEl || !endEl) return; 

        const startStr = startEl.value;
        const endStr = endEl.value;
        const startDate = startStr ? new Date(startStr) : null;
        const endDate = endStr ? new Date(endStr) : null;
        if(endDate) endDate.setHours(23, 59, 59);

        const filterFn = (item) => {
            if(!startDate && !endDate) return true;
            const itemDate = new Date(item.timestamp);
            if(startDate && itemDate < startDate) return false;
            if(endDate && itemDate > endDate) return false;
            return true;
        };

        const renderLog = (data, type, color) => {
          const filtered = data.filter(filterFn);
          if(!filtered.length) return '<p class="p-4 text-center text-gray-400">ไม่มีข้อมูลในช่วงเวลานี้</p>';
          return `<table class="w-full text-sm text-left"><thead class="bg-gray-50 sticky top-0"><tr><th class="p-3">เวลา</th><th class="p-3">รายการ</th><th class="p-3 text-right">จำนวน</th><th class="p-3 text-center">หลักฐาน</th></tr></thead><tbody>` +
          filtered.map(r => {
            const hasProof = r.proof_url && r.proof_url.length > 5;
            const canUpload = r.user_name === state.user.fullname && r.transaction_id;
            let proofBtn = '-';
            if (hasProof) proofBtn = `<a href="${r.proof_url}" target="_blank" class="text-indigo-600 hover:underline">ดูรูป</a>`;
            else if (canUpload) proofBtn = `<button onclick="openProofModal('${r.transaction_id}', '${type}')" class="text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">แนบรูป</button>`;
            return `<tr class="border-b hover:bg-gray-50"><td class="p-3 text-xs text-gray-500">${formatDate(r.timestamp)}<br>${r.user_name}</td><td class="p-3">${r.material_name}</td><td class="p-3 text-right font-bold ${color}">${r.qty}</td><td class="p-3">${proofBtn}</td></tr>`;
          }).join('') + `</tbody></table>`;
        };
        
        const wLog = document.getElementById('withdrawLog');
        if(wLog) wLog.innerHTML = renderLog(state.reports.withdraw, 'withdraw', 'text-rose-600');
        const iLog = document.getElementById('importLog');
        if(iLog) iLog.innerHTML = renderLog(state.reports.import, 'import', 'text-emerald-600');
    }

    // --- USERS ---
    async function renderUsers(c) {
      if(!c) return;
      if (state.user.role !== 'admin') return c.innerHTML = '<div class="p-10 text-center text-gray-400">Access Denied</div>';
      c.innerHTML = `
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden fade-in">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 border-b"><tr><th class="p-4">User</th><th class="p-4">Name</th><th class="p-4">Status</th><th class="p-4">Role</th><th class="p-4">Action</th></tr></thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>`;
      
      const users = await api('getUsers');
      cache.users = users; // Update local cache
      
      const tbody = document.getElementById('userTableBody');
      if (!tbody) return; 

      tbody.innerHTML = users.map(u => `
        <tr class="border-b hover:bg-gray-50">
            <td class="p-4 font-bold">${u.username}</td>
            <td class="p-4">${u.fullname}<br><span class="text-xs text-gray-400">${u.group}</span></td>
            <td class="p-4"><span class="px-2 py-1 rounded text-xs ${u.status==='approved'?'bg-green-100 text-green-800':u.status==='pending'?'bg-yellow-100':'bg-red-100'}">${u.status}</span></td>
            <td class="p-4 uppercase text-xs font-bold">${u.role}</td>
            <td class="p-4">
                ${u.status === 'pending' ? 
                `<button onclick="updateUser('${u.user_id}', 'approved')" class="text-green-600 mr-2">อนุมัติ</button><button onclick="updateUser('${u.user_id}', 'rejected')" class="text-red-600">ปฏิเสธ</button>` : 
                `<button onclick='openPermModal(${JSON.stringify(u)})' class="text-blue-600 bg-blue-50 px-3 py-1 rounded text-xs font-bold shadow-sm">กำหนดสิทธิ์</button>`}
            </td>
        </tr>`).join('');
    }

    // --- PERMISSION MODAL ---
    function openPermModal(u) {
        // Fix for Permission Data Types
        let perms = [];
        try { 
           if (Array.isArray(u.permissions)) perms = u.permissions;
           else if (typeof u.permissions === 'string') perms = JSON.parse(u.permissions);
        } catch(e) { perms = []; }
        
        document.getElementById('permUserName').innerText = u.fullname;
        document.getElementById('permUserInitials').innerText = u.fullname.charAt(0);
        document.getElementById('permUserId').value = u.user_id;
        
        document.getElementById('perm_view_stock').checked = true; 
        document.getElementById('perm_withdraw_material').checked = perms.includes('withdraw_material');
        document.getElementById('perm_import_material').checked = perms.includes('import_material');
        document.getElementById('perm_manage_material').checked = perms.includes('manage_material');
        
        document.getElementById('userPermModal').classList.remove('hidden');
    }
    
    async function savePermissions() {
        const uid = document.getElementById('permUserId').value;
        const p = ['view_stock'];
        if(document.getElementById('perm_withdraw_material').checked) p.push('withdraw_material');
        if(document.getElementById('perm_import_material').checked) p.push('import_material');
        if(document.getElementById('perm_manage_material').checked) p.push('manage_material');
        
        await api('updateUserStatus', { user_id: uid, permissions: p });
        closeModal('userPermModal');
        
        // Fix 1: Force Clear Cache & Reload
        cache.users = null;
        renderUsers(document.getElementById('contentArea'));
        showToast('บันทึกสิทธิ์เรียบร้อย');
    }

    function openMaterialModal(m){ document.getElementById('materialForm').reset(); toggleImgInput('file', 'mat'); if(m){document.getElementById('matId').value=m.material_id;document.getElementById('matName').value=m.name;document.getElementById('matImgUrl').value=m.image_url;}else{document.getElementById('matId').value='';} document.getElementById('materialModal').classList.remove('hidden'); }
    function openTransModal(type, m){ 
      document.getElementById('transForm').reset(); 
      document.getElementById('transType').value=type; document.getElementById('transMatId').value=m.material_id; 
      document.getElementById('transMatName').value=m.name; document.getElementById('transMatNameDisplay').innerText=m.name; 
      document.getElementById('transCurrentQty').innerText=m.qty; document.getElementById('transImgPreview').src=m.image_url;
      document.getElementById('transDate').valueAsDate = new Date(); 
      const isImport = type==='import';
      document.getElementById('transModalTitle').innerText = isImport?'นำเข้าสต๊อก':'เบิกวัสดุ';
      document.getElementById('btnTransSubmit').className = `w-full py-3 rounded-lg font-bold text-white shadow-md ${isImport?'bg-emerald-600':'bg-rose-600'}`;
      document.getElementById('importFields').classList.toggle('hidden', !isImport);
      document.getElementById('transModal').classList.remove('hidden'); 
    }
    function openProofModal(txId, type) { document.getElementById('proofForm').reset(); document.getElementById('proofTxId').value = txId; document.getElementById('proofType').value = type; document.getElementById('proofModal').classList.remove('hidden'); }

    // --- FORM SUBMITS ---
    document.getElementById('materialForm').onsubmit = async (e) => {
      e.preventDefault(); const id = document.getElementById('matId').value; const fileInput = document.getElementById('matImgFile');
      let payload = { name: document.getElementById('matName').value, image_url: document.getElementById('matImgUrl').value };
      if (fileInput.files.length > 0) { const r = new FileReader(); payload.image_data = await new Promise(res => { r.onload = evt => res(evt.target.result); r.readAsDataURL(fileInput.files[0]); }); }
      try { await api(id ? 'updateMaterial' : 'addMaterial', { ...payload, material_id: id }); closeModal('materialModal'); state.materials = await api('getMaterials'); renderMaterialList('view'); showToast('บันทึกสำเร็จ'); } catch(e) {}
    };

    document.getElementById('transForm').onsubmit = async (e) => {
      e.preventDefault(); const type = document.getElementById('transType').value;
      const dateStr = document.getElementById('transDate').value; const rawRef = document.getElementById('transRef').value;
      const combinedRef = (type === 'import' && dateStr) ? `[Date: ${dateStr}] ${rawRef}` : rawRef;
      const fileInput = document.getElementById('transProofFile'); let imageData = null;
      if (fileInput.files.length > 0) { const r = new FileReader(); imageData = await new Promise(res => { r.onload = evt => res(evt.target.result); r.readAsDataURL(fileInput.files[0]); }); }
      try {
        await api(type === 'import' ? 'importMaterial' : 'withdrawMaterial', {
          material_id: document.getElementById('transMatId').value, material_name: document.getElementById('transMatName').value,
          qty: document.getElementById('transQty').value, user_name: state.user.fullname, ref_doc: combinedRef, image_data: imageData
        });
        closeModal('transModal'); state.materials = await api('getMaterials'); renderMaterialList(type); showToast('ทำรายการสำเร็จ');
      } catch(e) {}
    };
    
    document.getElementById('proofForm').onsubmit = async (e) => {
      e.preventDefault(); const fileInput = document.getElementById('proofFile');
      if (fileInput.files.length > 0) {
        const r = new FileReader(); const imageData = await new Promise(res => { r.onload = evt => res(evt.target.result); r.readAsDataURL(fileInput.files[0]); });
        try {
            await api('uploadProof', { transaction_id: document.getElementById('proofTxId').value, type: document.getElementById('proofType').value, user_name: state.user.fullname, image_data: imageData });
            closeModal('proofModal'); state.reports = await api('getReports'); renderReports(document.getElementById('contentArea')); showToast('อัปโหลดสำเร็จ');
        } catch(e) {}
      } else showToast('เลือกรูปก่อน', 'error');
    };

    // --- UTILS ---
    function toggleImgInput(type, prefix) {
      const f=document.getElementById(prefix+'InputFile'), u=document.getElementById(prefix+'ImgUrl');
      if(f && u) { if(type==='file'){ f.classList.remove('hidden'); u.classList.add('hidden'); } else { f.classList.add('hidden'); u.classList.remove('hidden'); } }
    }
    function previewImage(input, prefix) {
      if (input.files[0]) { const r = new FileReader(); r.onload = e => { document.getElementById(prefix+'Preview').style.backgroundImage = `url(${e.target.result})`; document.getElementById(prefix+'Preview').classList.remove('hidden'); const ph=document.getElementById(prefix+'Placeholder'); if(ph)ph.classList.add('hidden'); }; r.readAsDataURL(input.files[0]); }
    }
    
    // CAMERA
    async function openCamera(target) { currentCamTarget = target; document.getElementById('cameraModal').classList.remove('hidden'); try { videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } }); document.getElementById('cameraVideo').srcObject = videoStream; } catch (e) { alert('Camera Error'); closeCamera(); } }
    function switchCamera() { if (videoStream) videoStream.getTracks().forEach(t => t.stop()); currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment'; openCamera(currentCamTarget); }
    function closeCamera() { document.getElementById('cameraModal').classList.add('hidden'); if (videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; } }
    function capturePhoto() {
      const v = document.getElementById('cameraVideo'), c = document.getElementById('cameraCanvas');
      c.width = 800; c.height = v.videoHeight * (800 / v.videoWidth); c.getContext('2d').drawImage(v, 0, 0, c.width, c.height);
      const dataUrl = c.toDataURL('image/jpeg', 0.7);
      fetch(dataUrl).then(r => r.blob()).then(blob => {
        const f = new File([blob], "cam.jpg", { type: "image/jpeg" }); const dt = new DataTransfer(); dt.items.add(f);
        let tid = currentCamTarget === 'mat' ? 'matImgFile' : currentCamTarget === 'trans' ? 'transProofFile' : 'proofFile';
        const el = document.getElementById(tid); if(el) { el.files = dt.files; previewImage(el, currentCamTarget); }
      });
      if(currentCamTarget==='mat') toggleImgInput('file', 'mat');
      closeCamera();
    }

    // EXPORT
    function exportCSV() {
      const data = [...state.reports.withdraw.map(x => ({...x, type: 'withdraw'})), ...state.reports.import.map(x => ({...x, type: 'import'}))];
      if (data.length === 0) return showToast('ไม่มีข้อมูล');
      const csv = "\uFEFFDate,Type,Item,Qty,User\n" + data.map(e => `${formatDate(e.timestamp)},${e.type},${e.material_name},${e.qty},${e.user_name}`).join("\n");
      const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" })); link.download = "report.csv"; document.body.appendChild(link); link.click();
    }
    
    function exportPDF() {
        // Fix: Auto-detect font from VFS to allow any name
        const { jsPDF } = window.jspdf;
        if (!jsPDF) { alert("PDF Library not loaded"); return; }
        
        const doc = new jsPDF();
        
        // Auto-detect font name in VFS
        const vfs = doc.internal.events.publish('addFileToVFS') || window.jspdf.vfs || doc.vfs;
        let fontName = 'Sarabun'; // Default fallback
        
        // Try to register font if VFS exists
        if (typeof pdfMake !== 'undefined' && pdfMake.vfs && pdfMake.vfs['THSarabunNew.ttf']) {
             // If we were using pdfMake VFS, we need to bridge it to jsPDF. 
             // But here we switched to jsPDF + Sarabun-Regular.ttf from CDN
             // Let's rely on the method below
        }

        // Method 2: Load font on fly if not present (Reliable)
        fetch('https://raw.githubusercontent.com/google/fonts/main/ofl/sarabun/Sarabun-Regular.ttf')
        .then(response => response.blob())
        .then(blob => {
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                const base64data = reader.result.split(',')[1];
                doc.addFileToVFS("Sarabun-Regular.ttf", base64data);
                doc.addFont("Sarabun-Regular.ttf", "Sarabun", "normal");
                doc.setFont("Sarabun");
                
                doc.text('Stock Report (รายงานสต๊อก)', 14, 20);
                doc.setFontSize(10);
                
                const data = [
                    ...state.reports.withdraw.map(r => [formatDate(r.timestamp), 'Withdraw', r.material_name, r.qty, r.user_name]),
                    ...state.reports.import.map(r => [formatDate(r.timestamp), 'Import', r.material_name, r.qty, r.user_name])
                ];
                
                doc.autoTable({
                    head: [['Date', 'Type', 'Item', 'Qty', 'User']],
                    body: data,
                    startY: 30,
                    styles: { font: 'Sarabun', fontStyle: 'normal' }
                });
                
                doc.save('stock_report.pdf');
            };
        }).catch(e => {
            alert("Cannot load Thai font. PDF will use default font.");
            // Fallback
            const data = [
                    ...state.reports.withdraw.map(r => [formatDate(r.timestamp), 'Withdraw', r.material_name, r.qty, r.user_name]),
                    ...state.reports.import.map(r => [formatDate(r.timestamp), 'Import', r.material_name, r.qty, r.user_name])
            ];
            doc.autoTable({
                head: [['Date', 'Type', 'Item', 'Qty', 'User']],
                body: data
            });
            doc.save('stock_report.pdf');
        });
    }

    // UTILS
    async function deleteMaterial(id) { if(confirm('ยืนยันลบ?')) { await api('deleteMaterial', { material_id: id }); state.materials = await api('getMaterials'); renderMaterialList('view'); } }
    async function updateUser(uid, status) { if(confirm('ยืนยัน?')) { await api('updateUserStatus', { user_id: uid, status }); renderUsers(document.getElementById('contentArea')); } }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function showToast(msg, type = 'success') { const t = document.getElementById('toast'); t.innerText = msg; t.className = `fixed top-5 right-5 z-[80] p-4 rounded shadow-lg text-white transform transition-all duration-300 translate-y-0 ${type === 'success' ? 'bg-emerald-600' : 'bg-rose-600'}`; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }
    function formatDate(d) { if (!d) return '-'; const dt = new Date(d); return isNaN(dt) ? '-' : dt.toLocaleDateString('th-TH') + ' ' + dt.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }); }
    function handleSearch(m) { state.filter.search = document.getElementById('searchInput').value; renderMaterialList(m); }
    function handleSort() { state.filter.sort = document.getElementById('sortSelect').value; renderMaterialList('view'); }
    function changePage(d) { state.pagination.currentPage += d; renderMaterialList('view'); }
    function renderPaginationControls(m) { const el = document.getElementById('paginationControls'); if(el) el.innerHTML = `<button onclick="changePage(-1)" class="px-2 border rounded" ${state.pagination.currentPage===1?'disabled':''}>&lt;</button><span class="px-2 text-sm">${state.pagination.currentPage}/${state.pagination.totalPages}</span><button onclick="changePage(1)" class="px-2 border rounded" ${state.pagination.currentPage===state.pagination.totalPages?'disabled':''}>&gt;</button>`; }
    function adjQty(d) { const el = document.getElementById('transQty'); el.value = Math.max(1, parseInt(el.value)+d); }
    
    function cardSkeleton() { return `<div class="bg-white p-6 rounded-xl shadow-sm h-32 border border-slate-100 animate-pulse"></div>`; }
    function statCard(title, value, icon, colorClass) {
      return `
        <div class="bg-white p-6 rounded-xl shadow-sm border flex items-center justify-between hover:shadow-md transition">
          <div>
            <p class="text-gray-500 text-sm mb-1">${title}</p>
            <p class="text-2xl font-bold text-slate-800">${value}</p>
          </div>
          <div class="w-12 h-12 rounded-full ${colorClass} bg-opacity-10 flex items-center justify-center text-${colorClass.split('-')[1]}-600">
            <i class="${icon} text-xl ${colorClass.replace('bg-', 'text-')}"></i>
          </div>
        </div>
      `;
    }

    window.onload = initApp;
  </script>
</body>
</html>
