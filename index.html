<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soil Color Chart Analyzer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF & html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .color-box { transition: all 0.3s ease; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .marker-box {
            position: absolute; width: 30px; height: 30px; border: 2px solid #00ff00;
            background-color: rgba(0, 255, 0, 0.2); box-shadow: 0 0 4px rgba(0,0,0,0.8);
            pointer-events: none; transform: translate(-50%, -50%); z-index: 10; display: none;
        }
        .center-reticle {
            position: absolute; top: 50%; left: 50%; width: 40px; height: 40px;
            border: 2px solid #ef4444;
            background-color: rgba(255, 0, 0, 0.1);
            transform: translate(-50%, -50%); pointer-events: none; z-index: 20;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.5);
        }
        .center-reticle::before, .center-reticle::after {
            content: ''; position: absolute; background: #ef4444;
        }
        .center-reticle::before { top: 50%; left: -10px; width: 60px; height: 1px; transform: translateY(-50%); }
        .center-reticle::after { left: 50%; top: -10px; height: 60px; width: 1px; transform: translateX(-50%); }
        
        .cursor-crosshair { cursor: crosshair; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column;
        }
        .status-toast {
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            background: #1f2937; color: white; padding: 12px 24px;
            border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none; align-items: center; gap: 10px;
            transition: opacity 0.3s ease;
        }
        .status-toast.show { display: flex; animation: slideIn 0.3s ease-out; }
        
        /* Sync Status Badge */
        .sync-badge {
            position: fixed; bottom: 20px; right: 20px;
            background: rgba(31, 41, 55, 0.9); color: white;
            padding: 10px 20px; border-radius: 30px;
            font-size: 14px; display: none; align-items: center; gap: 10px;
            z-index: 9999; pointer-events: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* A4 Report Template Style */
        #reportTemplate {
            width: 210mm; min-height: 297mm; padding: 20mm;
            background: white; color: black;
            position: fixed; left: -9999px; top: 0;
        }
        .credit-text {
            background: linear-gradient(to right, #10b981, #3b82f6);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: bold; letter-spacing: 1px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-2 md:p-8 flex flex-col">

    <!-- Status Toast -->
    <div id="statusToast" class="status-toast">
        <div id="toastIcon"></div>
        <div id="toastMessage"></div>
    </div>

    <!-- Sync Indicator -->
    <div id="syncBadge" class="sync-badge">
        <i class="fas fa-circle-notch fa-spin text-emerald-400"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
    </div>

    <!-- Loading Spinner -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <button onclick="showLoading(false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 p-2" title="‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏¥‡∏î">
            <i class="fas fa-times fa-2x"></i>
        </button>
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-emerald-600 mb-4"></div>
        <p id="loadingText" class="text-emerald-700 font-bold text-lg animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
        <p id="loadingSubText" class="text-sm text-gray-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
    </div>

    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden w-full flex-grow">
        
        <!-- Header -->
        <div class="bg-emerald-600 p-6 text-white relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                        <path d="M 40 0 L 0 0 0 40" fill="none" stroke="white" stroke-width="1"/>
                    </pattern>
                    <rect width="100%" height="100%" fill="url(#grid)" />
                </svg>
            </div>

            <div class="flex flex-col md:flex-row items-center justify-center gap-6 relative z-10">
                <div class="flex-shrink-0">
                     <svg width="80" height="80" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-xl hover:scale-105 transition-transform duration-300">
                        <circle cx="50" cy="50" r="48" fill="white" fill-opacity="0.95"/>
                        <circle cx="50" cy="50" r="45" stroke="#10B981" stroke-width="2" stroke-dasharray="8 4" stroke-opacity="0.5"/>
                        <path d="M20 75C20 75 35 65 50 65C65 65 80 75 80 75V85C80 85 65 90 50 90C35 90 20 85 20 85V75Z" fill="#8B4513"/>
                        <path d="M50 65V40" stroke="#A0522D" stroke-width="4" stroke-linecap="round"/>
                        <path d="M50 50C50 50 30 45 30 30C30 30 40 30 50 50Z" fill="#4ADE80"/>
                        <path d="M50 50C50 50 30 45 30 30C30 30 40 30 50 50Z" stroke="#16A34A" stroke-width="1"/>
                        <path d="M50 45C50 45 75 35 75 20C75 20 60 25 50 45Z" fill="#22C55E"/>
                        <path d="M50 45C50 45 75 35 75 20C75 20 60 25 50 45Z" stroke="#15803D" stroke-width="1"/>
                        <path d="M50 40C50 40 50 15 35 25C35 25 45 30 50 40Z" fill="#86EFAC"/>
                        <circle cx="30" cy="30" r="2" fill="#FBBF24"/>
                        <circle cx="70" cy="25" r="2" fill="#FBBF24"/>
                        <circle cx="50" cy="15" r="2" fill="#FBBF24"/>
                    </svg>
                </div>
                <div class="text-center md:text-left">
                    <h1 class="text-2xl md:text-3xl font-bold tracking-wide text-white drop-shadow-md">
                        Soil Color Chart Analyzer Pro
                    </h1>
                    <p class="mt-2 text-emerald-100 font-light text-sm md:text-base">
                        <i class="fas fa-flask mr-2"></i>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏ä‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏¥‡∏ô
                    </p>
                    <div id="dbStatus" class="text-xs text-yellow-200 mt-2 bg-black/20 px-2 py-1 rounded inline-block">
                        <i class="fas fa-database"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Cloud Auto-Sync)
                    </div>
                </div>
            </div>
            
            <div id="userInfoDisplay" class="absolute top-4 right-4 text-sm hidden z-20">
                <span id="loggedInUser" class="font-bold mr-2 bg-emerald-700 px-3 py-1 rounded-full bg-opacity-50 text-white"></span>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-xs transition shadow-md font-bold text-white">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            
             <!-- Top Right Status Icon -->
            <div class="absolute top-4 right-4 z-10 flex gap-4 items-center" id="statusIconContainer">
                <div id="topRightStatus" class="flex items-center justify-center bg-white/20 backdrop-blur-sm rounded-full w-10 h-10 shadow-lg">
                    <i class="fas fa-times-circle text-red-500 text-2xl drop-shadow-md"></i>
                </div>
            </div>
        </div>

        <div class="p-4 md:p-6">
            <div class="flex border-b mb-6">
                <button onclick="switchTab('analyze')" id="btn-analyze" class="flex-1 py-3 text-emerald-600 border-b-2 border-emerald-600 font-bold focus:outline-none transition">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•</button>
                <button onclick="switchTab('config')" id="btn-config" class="flex-1 py-3 text-gray-500 hover:text-emerald-500 font-medium focus:outline-none transition">‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Admin)</button>
            </div>

            <!-- ANALYZE TAB -->
            <div id="tab-analyze" class="block animate-fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 lg:gap-8">
                    <div class="space-y-3 lg:space-y-6">
                        <div class="bg-white border rounded-lg p-4 shadow-sm">
                            <label class="font-bold text-gray-700 mb-2 block">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏≤‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à:</label>
                            <select id="testType" class="w-full border rounded p-2 bg-gray-50 text-gray-700 font-semibold" onchange="analyzeSoil()">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <label class="font-bold text-gray-700 mb-2 block">2. ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏µ (Source):</label>
                            <div class="flex gap-2 mb-4">
                                <button onclick="toggleCamera()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded shadow text-sm">
                                    <i class="fas fa-camera mr-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏Å‡∏•‡πâ‡∏≠‡∏á
                                </button>
                                <button onclick="triggerFileUpload()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded shadow text-sm">
                                    <i class="fas fa-image mr-1"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
                                </button>
                                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                            </div>
                            <div id="mediaContainer" class="relative w-full h-64 bg-black rounded-lg overflow-hidden hidden cursor-crosshair group" onclick="handleMediaClick(event)">
                                <button onclick="switchCamera(event)" id="btnFlipCamera" class="absolute top-2 right-2 bg-white/80 hover:bg-white text-gray-800 p-3 rounded-full shadow-lg z-30 transition transform active:scale-95 hidden">
                                    <i class="fas fa-sync-alt fa-lg text-emerald-600"></i>
                                </button>
                                <video id="videoElement" autoplay playsinline class="absolute top-0 left-0 w-full h-full object-contain hidden opacity-0"></video>
                                <img id="imagePreview" class="absolute top-0 left-0 w-full h-full object-contain hidden opacity-0" />
                                <canvas id="canvasElement" class="absolute top-0 left-0 w-full h-full"></canvas>
                                <!-- Center Reticle for Camera Mode -->
                                <div id="centerReticle" class="center-reticle hidden"></div>
                                <!-- Click Marker for Image Mode -->
                                <div id="colorMarker" class="marker-box hidden"></div>
                            </div>
                        </div>

                        <button id="btnManualAnalyze" onclick="analyzeSoil()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-lg text-lg transition transform active:scale-95 hidden">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                        <p class="text-center text-xs text-gray-400 mt-2" id="autoAnalyzeStatus"></p>
                    </div>

                    <div class="flex flex-col h-full space-y-4 md:space-y-6">
                        <!-- Result Section -->
                        <div class="flex flex-col justify-center items-center bg-emerald-50 rounded-xl border-2 border-emerald-100 p-3 text-center shadow-sm min-h-[120px] relative">
                            <button onclick="generatePDFReport()" class="absolute top-2 right-2 text-emerald-600 hover:text-emerald-800 p-2 text-xs font-bold border border-emerald-200 rounded hover:bg-emerald-100 transition">
                                <i class="fas fa-file-pdf fa-lg"></i> Export PDF
                            </button>
                            <h3 class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
                            <div id="resultText" class="text-2xl md:text-5xl font-extrabold text-gray-300 animate-pulse">...</div>
                            <div id="resultDesc" class="mt-1 text-sm text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏≤‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡∏µ</div>
                        </div>

                        <!-- RGB Adjustment Section (Collapsible) -->
                        <div id="rgbAdjustSection" class="bg-gray-100 p-4 rounded-lg relative shadow-inner">
                            <div class="flex justify-between items-center mb-2">
                                <h2 class="text-xs font-bold text-gray-500 uppercase">3. ‡∏Ñ‡πà‡∏≤‡∏™‡∏µ RGB (‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á)</h2>
                                <button id="btnPauseAnalysis" onclick="toggleAnalysisPause()" class="text-[10px] bg-white hover:bg-gray-50 text-gray-600 px-2 py-1 rounded border border-gray-300 shadow-sm transition">
                                    <i class="fas fa-pause mr-1"></i> ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤
                                </button>
                            </div>
                            <!-- Compact RGB Input Grid -->
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <div class="flex flex-col items-center">
                                    <label class="text-xs font-bold text-red-600 mb-1">R</label>
                                    <input type="number" id="inputR" min="0" max="255" value="128" class="w-full p-2 text-center border rounded text-sm font-mono border-red-200 focus:border-red-500 focus:ring-1 focus:ring-red-200 outline-none transition-colors" oninput="updateInputDisplay()">
                                </div>
                                <div class="flex flex-col items-center">
                                    <label class="text-xs font-bold text-green-600 mb-1">G</label>
                                    <input type="number" id="inputG" min="0" max="255" value="128" class="w-full p-2 text-center border rounded text-sm font-mono border-green-200 focus:border-green-500 focus:ring-1 focus:ring-green-200 outline-none transition-colors" oninput="updateInputDisplay()">
                                </div>
                                <div class="flex flex-col items-center">
                                    <label class="text-xs font-bold text-blue-600 mb-1">B</label>
                                    <input type="number" id="inputB" min="0" max="255" value="128" class="w-full p-2 text-center border rounded text-sm font-mono border-blue-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-200 outline-none transition-colors" oninput="updateInputDisplay()">
                                </div>
                            </div>
                            
                            <!-- HSV Display Section -->
                            <div id="hsvDisplayContainer" class="mt-2 p-2 bg-indigo-50 rounded-lg border border-indigo-200 shadow-sm">
                                <div class="flex justify-between items-center text-indigo-800 mb-1">
                                    <span class="font-bold text-xs uppercase"><i class="fas fa-palette mr-1"></i> ‡∏Ñ‡πà‡∏≤‡∏™‡∏µ HSV</span>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-center text-xs font-mono">
                                    <div class="bg-white p-1 rounded shadow-sm">
                                        <div class="text-[10px] text-gray-400">Hue</div>
                                        <div id="valH" class="font-bold text-indigo-600">0¬∞</div>
                                    </div>
                                    <div class="bg-white p-1 rounded shadow-sm">
                                        <div class="text-[10px] text-gray-400">Sat</div>
                                        <div id="valS" class="font-bold text-indigo-600">0%</div>
                                    </div>
                                    <div class="bg-white p-1 rounded shadow-sm">
                                        <div class="text-[10px] text-gray-400">Val</div>
                                        <div id="valV" class="font-bold text-indigo-600">0%</div>
                                    </div>
                                </div>
                            </div>

                            <div id="brightnessContainer" class="mt-2 p-2 bg-yellow-100 rounded border border-yellow-300 hidden">
                                <div class="flex justify-between items-center text-yellow-800">
                                    <span class="font-bold text-xs"><i class="fas fa-sun mr-1"></i> Brightness</span>
                                    <span id="valBrightness" class="font-mono font-bold text-sm">0</span>
                                </div>
                            </div>
                            
                            <div class="mt-3 flex items-center gap-3">
                                <div class="text-xs text-gray-500 font-bold">Preview:</div>
                                <div id="colorPreview" class="w-full h-8 rounded shadow-inner border border-gray-300 bg-gray-400 transition-colors duration-200"></div>
                            </div>
                        </div>

                        <!-- Calibration Section (Collapsible) -->
                        <div id="calibrationSection" class="bg-orange-50 border border-orange-200 rounded-lg p-4 mt-4">
                            <h4 class="font-bold text-orange-800 mb-2 text-sm"><i class="fas fa-balance-scale"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏™‡∏á‡∏Ç‡∏≤‡∏ß (Calibration)</h4>
                            <div class="flex gap-2 mb-2">
                                <button onclick="calibrateSystem()" class="bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded text-sm shadow flex-1">
                                    <i class="fas fa-magic"></i> Calibrate
                                </button>
                                <button onclick="resetCalibration()" class="bg-gray-400 hover:bg-gray-500 text-white py-2 px-4 rounded text-sm shadow">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                            </div>
                            <div id="calibrationStatus" class="text-xs text-orange-700 mt-1">
                                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Calibrate (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏î‡∏¥‡∏ö)
                            </div>
                            <div id="lightQualityStatus" class="text-xs font-bold mt-1 text-gray-500">
                                ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÅ‡∏™‡∏á: ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADMIN TAB -->
            <div id="tab-config" class="hidden">
                <div id="login-panel" class="max-w-sm mx-auto mt-10 p-6 bg-white border rounded-xl shadow-md">
                    <div class="text-center mb-6">
                        <div class="bg-emerald-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2 text-emerald-600"><i class="fas fa-user-lock text-2xl"></i></div>
                        <h2 class="text-xl font-bold text-gray-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    </div>
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">Username</label><input type="text" id="username" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-emerald-500" placeholder="Username" required></div>
                        <div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2">Password</label><input type="password" id="password" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-emerald-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
                        <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-2 rounded hover:bg-emerald-700 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                        <p id="loginError" class="text-red-500 text-xs mt-3 text-center hidden">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
                    </form>
                </div>

                <div id="admin-panel" class="hidden">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="w-full md:w-1/4">
                            <div class="bg-gray-100 rounded-lg p-2 space-y-1">
                                <button onclick="switchAdminTab('color-config')" id="menu-color-config" class="w-full text-left px-4 py-2 rounded hover:bg-white hover:shadow font-medium text-emerald-700 bg-white shadow"><i class="fas fa-palette w-6"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ</button>
                                <button onclick="switchAdminTab('user-manage')" id="menu-user-manage" class="w-full text-left px-4 py-2 rounded hover:bg-white hover:shadow font-medium text-gray-600"><i class="fas fa-users-cog w-6"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                                <button onclick="switchAdminTab('change-pass')" id="menu-change-pass" class="w-full text-left px-4 py-2 rounded hover:bg-white hover:shadow font-medium text-gray-600"><i class="fas fa-key w-6"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
                                <button onclick="switchAdminTab('system-status')" id="menu-system-status" class="w-full text-left px-4 py-2 rounded hover:bg-white hover:shadow font-medium text-gray-600"><i class="fas fa-server w-6"></i> Cloud Status</button>
                            </div>
                        </div>
                        <div class="w-full md:w-3/4 bg-white border rounded-lg p-6">
                            
                            <!-- Cloud Status -->
                            <div id="admin-system-status" class="hidden">
                                <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö Cloud</h3>
                                <div class="bg-emerald-50 p-4 rounded text-sm text-emerald-800 mb-4 border border-emerald-200">
                                    <p class="font-bold"><i class="fas fa-wifi"></i> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
                                    <p class="text-xs mt-2 text-gray-600">URL: ...Script.google.com.../exec</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="forceSyncData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"><i class="fas fa-sync"></i> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ / ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Sync</button>
                                    <button onclick="resetToDefaults()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"><i class="fas fa-trash-restore"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
                                </div>
                            </div>

                            <!-- Color Config -->
                            <div id="admin-color-config" class="block">
                                <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏µ (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)</h3>
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r space-y-3">
                                    <h4 class="font-bold text-gray-800 border-b border-yellow-200 pb-1">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h4>
                                    <div class="flex items-center"><input type="checkbox" id="toggleBrightness" class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500" onchange="toggleBrightnessSetting()"><label for="toggleBrightness" class="ml-2 text-gray-700 font-medium cursor-pointer">‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</label></div>
                                    <div class="flex items-center"><input type="checkbox" id="toggleRealTime" class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500" onchange="toggleRealTimeSetting()"><label for="toggleRealTime" class="ml-2 text-gray-700 font-medium cursor-pointer">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏• Real-time</label></div>
                                    <div class="mt-3 border-t border-yellow-200 pt-3">
                                        <label class="block text-gray-700 font-medium mb-1 text-sm"><i class="fas fa-video mr-1"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á</label>
                                        <div class="flex gap-2"><select id="cameraSelect" class="flex-1 p-2 border rounded text-sm bg-white" onchange="updateCameraSelection()"><option value="">-- ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ --</option></select><button onclick="populateCameraList()" class="bg-yellow-500 text-white px-3 py-1 rounded text-xs hover:bg-yellow-600" title="Refresh"><i class="fas fa-sync"></i></button></div>
                                    </div>
                                    
                                    <!-- New Settings: UI Visibility & Test Types -->
                                    <div class="mt-3 border-t border-yellow-200 pt-3">
                                        <label class="block text-gray-700 font-medium mb-2 text-sm"><i class="fas fa-cogs mr-1"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Interface)</label>
                                        <div class="space-y-2" id="settingsContainer">
                                            <!-- Will be populated by JS -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex justify-between items-center mt-6 mb-2">
                                    <h4 class="font-bold text-gray-700">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏µ</h4>
                                    <div class="flex gap-2">
                                        <button onclick="exportXLSX()" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 shadow"><i class="fas fa-file-excel"></i> Export</button>
                                        <button onclick="triggerImportXLSX()" class="bg-orange-500 text-white px-3 py-1 rounded text-xs hover:bg-orange-600 shadow"><i class="fas fa-file-import"></i> Import</button>
                                        <input type="file" id="xlsxFileInput" accept=".xlsx" class="hidden" onchange="handleImportXLSX(event)">
                                    </div>
                                </div>
                                
                                <div class="overflow-x-auto mb-6 max-h-96 overflow-y-auto border rounded"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"><tr>
                                    <th class="px-3 py-3">Type</th><th class="px-3 py-3">Level</th>
                                    <th class="px-1 py-3 text-center bg-red-50 text-red-600">R</th><th class="px-1 py-3 text-center bg-green-50 text-green-600">G</th><th class="px-1 py-3 text-center bg-blue-50 text-blue-600">B</th>
                                    <th class="px-1 py-3 text-center bg-indigo-50 text-indigo-600">H</th><th class="px-1 py-3 text-center bg-indigo-50 text-indigo-600">S</th><th class="px-1 py-3 text-center bg-indigo-50 text-indigo-600">V</th>
                                    <th class="px-3 py-3 text-center">Action</th>
                                </tr></thead><tbody id="configTableBody"></tbody></table></div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg border">
                                    <h4 class="font-bold text-sm mb-2 text-gray-700" id="formTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà</h4>
                                    
                                    <!-- RGB Inputs -->
                                    <div class="text-xs font-bold text-gray-500 mb-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ & RGB</div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-2">
                                        <input id="newType" type="text" placeholder="Type" class="p-2 border rounded text-sm">
                                        <input id="newLevel" type="text" placeholder="Level" class="p-2 border rounded text-sm">
                                        <input id="newRMin" type="number" placeholder="R Min" class="p-2 border rounded text-sm border-red-200">
                                        <input id="newRMax" type="number" placeholder="R Max" class="p-2 border rounded text-sm border-red-200">
                                        <input id="newGMin" type="number" placeholder="G Min" class="p-2 border rounded text-sm border-green-200">
                                        <input id="newGMax" type="number" placeholder="G Max" class="p-2 border rounded text-sm border-green-200">
                                        <input id="newBMin" type="number" placeholder="B Min" class="p-2 border rounded text-sm border-blue-200">
                                        <input id="newBMax" type="number" placeholder="B Max" class="p-2 border rounded text-sm border-blue-200">
                                    </div>
                                    
                                    <!-- HSV Inputs (New) -->
                                    <div class="text-xs font-bold text-indigo-500 mb-1 mt-3">‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≤ HSV (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∞‡πÉ‡∏ä‡πâ RGB ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</div>
                                    <div class="grid grid-cols-3 md:grid-cols-6 gap-2 mb-2">
                                        <input id="newHMin" type="number" placeholder="H Min" class="p-2 border rounded text-sm border-indigo-200">
                                        <input id="newHMax" type="number" placeholder="H Max" class="p-2 border rounded text-sm border-indigo-200">
                                        <input id="newSMin" type="number" placeholder="S Min" class="p-2 border rounded text-sm border-indigo-200">
                                        <input id="newSMax" type="number" placeholder="S Max" class="p-2 border rounded text-sm border-indigo-200">
                                        <input id="newVMin" type="number" placeholder="V Min" class="p-2 border rounded text-sm border-indigo-200">
                                        <input id="newVMax" type="number" placeholder="V Max" class="p-2 border rounded text-sm border-indigo-200">
                                    </div>

                                    <div class="flex gap-2 mt-2">
                                        <button id="btnSaveRange" onclick="saveRange()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm flex-1"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                        <button id="btnCancelEdit" onclick="cancelEdit()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 text-sm hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    </div>
                                </div>
                            </div>

                            <div id="admin-user-manage" class="hidden">
                                <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Admin Only)</h3>
                                <div class="mb-6"><table class="w-full text-sm text-left text-gray-500 border rounded"><thead class="bg-gray-100 text-gray-700"><tr><th class="px-4 py-2">Username</th><th class="px-4 py-2">Role</th><th class="px-4 py-2 text-right">Action</th></tr></thead><tbody id="userTableBody"></tbody></table></div>
                                <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="font-bold text-sm mb-2 text-gray-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h4><div class="flex gap-2"><input id="newUsername" type="text" placeholder="Username" class="flex-1 p-2 border rounded text-sm"><input id="newPassword" type="text" placeholder="Password" class="flex-1 p-2 border rounded text-sm"><button onclick="addUser()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á</button></div></div>
                            </div>

                            <div id="admin-change-pass" class="hidden">
                                <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                                <div class="max-w-md"><div class="mb-4"><label class="block text-gray-700 text-sm mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label><input type="password" id="changeNewPass" class="w-full p-2 border rounded"></div><div class="mb-4"><label class="block text-gray-700 text-sm mb-1">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label><input type="password" id="changeConfirmPass" class="w-full p-2 border rounded"></div><button onclick="changePassword()" class="bg-orange-500 text-white px-6 py-2 rounded hover:bg-orange-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden A4 Template for PDF Export -->
    <div id="reportTemplate" class="bg-white p-8 hidden text-black" style="width: 210mm; min-height: 297mm; font-family: 'Sarabun', sans-serif;">
        <div class="flex justify-between items-center border-b-2 border-emerald-600 pb-4 mb-6">
            <div class="flex items-center gap-4">
                <div class="text-4xl text-emerald-600"><i class="fas fa-flask"></i></div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏¥‡∏ô</h1>
                    <p class="text-sm text-gray-500">Soil Color Chart Analyzer Pro Report</p>
                </div>
            </div>
            <div class="text-right text-sm text-gray-600">
                <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="reportDate"></span></p>
                <p>‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö: <span id="reportUser"></span></p>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-8">
            <div>
                <div class="bg-gray-100 p-2 rounded-lg border border-gray-300 flex justify-center items-center" style="height: 300px;">
                    <img id="reportImage" class="max-w-full max-h-full object-contain" />
                </div>
                <p class="text-center text-xs text-gray-400 mt-2">* ‡∏à‡∏∏‡∏î‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏™‡∏µ</p>
            </div>
            <div class="space-y-6">
                <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-6 text-center">
                    <h3 class="text-emerald-800 font-bold text-sm uppercase tracking-wide">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Result)</h3>
                    <div id="reportResultLevel" class="text-4xl font-extrabold text-emerald-600 mt-2">N/A</div>
                    <div id="reportResultType" class="text-gray-600 font-medium mt-1">N/A</div>
                </div>
                <table class="w-full text-sm border-collapse">
                    <tr class="border-b"><th class="py-2 text-left text-gray-500">‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</th><th class="py-2 text-right text-gray-800">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ</th></tr>
                    <tr class="border-b"><td class="py-2">‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡πÅ‡∏î‡∏á (R)</td><td class="py-2 text-right font-mono" id="reportR">0</td></tr>
                    <tr class="border-b"><td class="py-2">‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (G)</td><td class="py-2 text-right font-mono" id="reportG">0</td></tr>
                    <tr class="border-b"><td class="py-2">‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (B)</td><td class="py-2 text-right font-mono" id="reportB">0</td></tr>
                    
                    <!-- Added HSV to PDF -->
                    <tr class="border-b"><td class="py-2">Hue (H)</td><td class="py-2 text-right font-mono" id="reportH">0¬∞</td></tr>
                    <tr class="border-b"><td class="py-2">Saturation (S)</td><td class="py-2 text-right font-mono" id="reportS">0%</td></tr>
                    <tr class="border-b"><td class="py-2">Value (V)</td><td class="py-2 text-right font-mono" id="reportV">0%</td></tr>
                    
                    <tr><td class="py-2 font-bold text-yellow-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á (Brightness)</td><td class="py-2 text-right font-bold text-yellow-700 font-mono" id="reportBrightness">0</td></tr>
                </table>
            </div>
        </div>
        <div class="mt-12 text-center text-xs text-gray-400 border-t pt-4">
            <p>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° Soil Color Chart Analyzer Pro</p>
        </div>
    </div>

    <div class="text-center mt-4"><p class="text-xs font-mono credit-text opacity-70 hover:opacity-100 transition duration-300">‚ú® Design by AAAmacky</p></div>

<script>
    // --- STORAGE ENGINE (HARDCODED) ---
    const HARDCODED_SHEET_URL = 'https://script.google.com/macros/s/AKfycbxSscpgNcVG9vAvwH6Ccw44AQbh6LtE9Pwp7dfBIw35OeG4SZfTYg3vqmqCS3eCQYRJ/exec';

    const StorageEngine = {
        async get(key) {
            try {
                const response = await fetch(`${HARDCODED_SHEET_URL}?action=read&key=${encodeURIComponent(key)}&t=${Date.now()}`);
                const result = await response.json();
                if(result.status === 'success') {
                    if(result.data) localStorage.setItem(key, JSON.stringify(result.data));
                    return result.data ? JSON.stringify(result.data) : null;
                }
            } catch(e) { console.error("Cloud Read Error", e); }
            return localStorage.getItem(key); 
        },

        async set(key, value) {
            localStorage.setItem(key, value);
            // Optimistic save (no await) - Fire and forget
            fetch(`${HARDCODED_SHEET_URL}?action=write&key=${encodeURIComponent(key)}`, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: value
            }).then(() => {
                showSyncBadge(false);
                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Cloud ‡πÅ‡∏•‡πâ‡∏ß");
            }).catch(e => { 
                console.error("Cloud Write Error", e);
                showSyncBadge(false);
                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Cloud ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)", "error");
            });
            showSyncBadge(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
        }
    };

    // --- GLOBAL STATE ---
    const ALL_TEST_TYPES = ['N', 'Nitrate', 'P', 'K', 'Soil Respiration', 'pH'];
    let users = [];
    let currentUser = null;
    let mySoilData = []; 
    let myPreferences = { 
        showBrightness: false, 
        useRealTimeAnalysis: true, 
        selectedCameraId: '',
        showRGBAdjust: true, // New
        showCalibration: true, // New
        visibleTestTypes: ['N', 'Nitrate', 'P', 'K', 'Soil Respiration', 'pH'] // New
    };
    let editIndex = -1; // -1 means add mode
    let isCameraActive = false;
    let isAnalysisPaused = false; 
    let markerPosition = null; 
    let currentFacingMode = 'environment';
    
    // Calibration State
    let calibrationOffsets = { r: 0, g: 0, b: 0 };
    let lastRawRGB = { r: 0, g: 0, b: 0 }; // Stores raw reading for calibration
    const MARKER_SIZE = 30;

    // --- DEFAULTS ---
    const DEFAULT_USERS = [
        { id: 1, username: 'admin', password: 'admin123', role: 'admin' }, 
        { id: 2, username: 'staff', password: '123', role: 'user' }
    ];
    // Populate defaults with empty HSV ranges for backward compatibility logic
    // Structure: r: [min, max], h: [min, max] (optional)
    const DEFAULT_SOIL_DATA = [
        { type: 'N', level: '‡∏ï‡πà‡∏≥ (Low)', r: [200, 255], g: [180, 230], b: [180, 230] }, 
        { type: 'N', level: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Medium)', r: [200, 255], g: [100, 179], b: [100, 179] },
        { type: 'N', level: '‡∏™‡∏π‡∏á (High)', r: [150, 255], g: [0, 99], b: [0, 99] },
        { type: 'Nitrate', level: '‡∏ï‡πà‡∏≥ (0-10)', r: [240, 255], g: [240, 255], b: [240, 255] },
        { type: 'Nitrate', level: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (10-25)', r: [230, 250], g: [200, 220], b: [230, 250] },
        { type: 'Nitrate', level: '‡∏™‡∏π‡∏á (>25)', r: [200, 230], g: [150, 180], b: [200, 230] },
        { type: 'P', level: '‡∏ï‡πà‡∏≥ (Low)', r: [180, 220], g: [180, 220], b: [220, 255] },
        { type: 'P', level: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Medium)', r: [100, 179], g: [100, 179], b: [100, 179] },
        { type: 'P', level: '‡∏™‡∏π‡∏á (High)', r: [0, 99], g: [0, 99], b: [150, 255] },
        { type: 'K', level: '‡∏ï‡πà‡∏≥ (Low)', r: [240, 255], g: [240, 255], b: [200, 240] },
        { type: 'K', level: '‡∏™‡∏π‡∏á (High)', r: [200, 230], g: [200, 230], b: [100, 180] },
        { type: 'Soil Respiration', level: '‡∏ï‡πà‡∏≥ (Low)', r: [200, 220], g: [200, 220], b: [200, 220] }, 
        { type: 'Soil Respiration', level: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Medium)', r: [150, 180], g: [150, 180], b: [150, 180] },
        { type: 'Soil Respiration', level: '‡∏™‡∏π‡∏á (High)', r: [100, 130], g: [100, 130], b: [100, 130] },
        { type: 'pH', level: '4.5 (‡∏Å‡∏£‡∏î‡∏à‡∏±‡∏î)', r: [255, 255], g: [150, 180], b: [150, 180] }, 
        { type: 'pH', level: '7.0 (‡∏Å‡∏•‡∏≤‡∏á)', r: [100, 150], g: [200, 250], b: [100, 150] } 
    ];

    // --- HELPER FUNCTIONS ---
    function rgbToHsv(r, g, b) {
        r /= 255, g /= 255, b /= 255;
        var max = Math.max(r, g, b), min = Math.min(r, g, b);
        var h, s, v = max;
        var d = max - min;
        s = max == 0 ? 0 : d / max;
        if (max == min) { h = 0; } 
        else {
            switch (max) {
                case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                case g: h = (b - r) / d + 2; break;
                case b: h = (r - g) / d + 4; break;
            }
            h /= 6;
        }
        return { h: Math.round(h * 360), s: Math.round(s * 100), v: Math.round(v * 100) };
    }

    function populateCameraList() {
        const select = document.getElementById('cameraSelect');
        if (!select) return;
        select.innerHTML = '<option value="">-- ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ --</option>';
        navigator.mediaDevices.enumerateDevices().then(devices => {
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            videoDevices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Camera ${index + 1}`; 
                if(device.deviceId === myPreferences.selectedCameraId) option.selected = true;
                select.appendChild(option);
            });
        });
    }

    function toggleAnalysisPause() {
        isAnalysisPaused = !isAnalysisPaused;
        const btn = document.getElementById('btnPauseAnalysis');
        if(!btn) return;
        
        const video = document.getElementById('videoElement');

        if (isAnalysisPaused) {
            // Pause
            btn.innerHTML = '<i class="fas fa-play mr-1"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠';
            btn.className = "text-[10px] bg-green-50 hover:bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200 shadow-sm transition";
            if (isCameraActive && video) video.pause(); // Stop video stream
        } else {
            // Resume
            btn.innerHTML = '<i class="fas fa-pause mr-1"></i> ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤';
            btn.className = "text-[10px] bg-white hover:bg-gray-50 text-gray-600 px-2 py-1 rounded border border-gray-300 shadow-sm transition";
             if (isCameraActive && video) video.play(); // Resume video stream
        }
    }

    function analyzeSoil() {
        const inputR = document.getElementById('inputR');
        if(!inputR) return;
        const r = parseInt(inputR.value);
        const g = parseInt(document.getElementById('inputG').value);
        const b = parseInt(document.getElementById('inputB').value);
        const type = document.getElementById('testType').value;
        const candidates = mySoilData.filter(d => d.type === type);
        let match = null, closest = null, minD = Infinity;

        // Current Values
        const currentHSV = rgbToHsv(r, g, b);

        // --- UPDATED FLEXIBLE LOGIC ---
        // Match ONLY valid criteria (NaN/Null/Undefined are ignored)
        
        // Helper to check if a single range is valid (has 2 numbers)
        const isValidRange = (arr) => arr && arr.length === 2 && !isNaN(arr[0]) && !isNaN(arr[1]) && arr[0] !== null && arr[1] !== null;

        for(let item of candidates) {
            let isMatch = true; // Assume match, fail if any VALID criteria fails
            let criteriaCount = 0; // Ensure at least one criteria exists

            // Check RGB
            if (isValidRange(item.r)) {
                criteriaCount++;
                if (r < item.r[0] || r > item.r[1]) isMatch = false;
            }
            if (isValidRange(item.g)) {
                criteriaCount++;
                if (g < item.g[0] || g > item.g[1]) isMatch = false;
            }
            if (isValidRange(item.b)) {
                criteriaCount++;
                if (b < item.b[0] || b > item.b[1]) isMatch = false;
            }

            // Check HSV
            if (isValidRange(item.h)) {
                criteriaCount++;
                if (currentHSV.h < item.h[0] || currentHSV.h > item.h[1]) isMatch = false;
            }
            if (isValidRange(item.s)) {
                criteriaCount++;
                if (currentHSV.s < item.s[0] || currentHSV.s > item.s[1]) isMatch = false;
            }
            if (isValidRange(item.v)) {
                criteriaCount++;
                if (currentHSV.v < item.v[0] || currentHSV.v > item.v[1]) isMatch = false;
            }

            // Only consider it a match if at least one criteria was checked and all checked passed
            if (criteriaCount > 0 && isMatch) {
                match = item;
                break;
            }
        }

        // Closest Match (Simple Euclidean on RGB for fallback if only RGB exists, or ignore)
        if (!match) {
            for(let item of candidates) {
                if (!isValidRange(item.r)) continue; // Only calc distance if RGB exists
                const centerR = (item.r[0] + item.r[1]) / 2;
                const centerG = (item.g[0] + item.g[1]) / 2;
                const centerB = (item.b[0] + item.b[1]) / 2;
                const dist = Math.sqrt(Math.pow(r - centerR, 2) + Math.pow(g - centerG, 2) + Math.pow(b - centerB, 2));
                if(dist < minD) { minD = dist; closest = item; }
            }
        }

        const txt = document.getElementById('resultText');
        const desc = document.getElementById('resultDesc');
        if (!txt) return;
        
        if(match) {
            txt.innerText = match.level; txt.className = "text-2xl md:text-5xl font-extrabold text-emerald-600"; desc.innerText = "‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå (Match)";
        } else if (closest && minD < 80) { 
            txt.innerText = closest.level + "*"; txt.className = "text-2xl md:text-5xl font-extrabold text-yellow-600"; desc.innerText = "‡∏Ñ‡πà‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (Approx)";
        } else {
            txt.innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; txt.className = "text-2xl md:text-5xl font-extrabold text-gray-400"; desc.innerText = "‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        }
    }

    function updateInputDisplay() {
        const rEl = document.getElementById('inputR');
        if(!rEl) return;
        const r = rEl.value;
        const g = document.getElementById('inputG').value;
        const b = document.getElementById('inputB').value;
        
        // Update RGB Display
        document.getElementById('colorPreview').style.backgroundColor = `rgb(${r},${g},${b})`;
        
        // Convert and Update HSV Display
        const hsv = rgbToHsv(r, g, b);
        const valH = document.getElementById('valH');
        const valS = document.getElementById('valS');
        const valV = document.getElementById('valV');
        
        if (valH) valH.innerText = hsv.h + '¬∞';
        if (valS) valS.innerText = hsv.s + '%';
        if (valV) valV.innerText = hsv.v + '%';
        
        if(myPreferences.useRealTimeAnalysis) analyzeSoil();
    }

    function updateSystemStatus(isReady) {
        const dbStatus = document.getElementById('dbStatus');
        const topRightStatus = document.getElementById('topRightStatus');
        
        if (!dbStatus || !topRightStatus) return; // Safety check

        if(isReady) {
            dbStatus.innerHTML = '<i class="fas fa-check-circle"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Cloud Auto-Sync)';
            dbStatus.className = "text-xs text-yellow-200 mt-2 bg-black/20 px-2 py-1 rounded inline-block";
            topRightStatus.innerHTML = '<i class="fas fa-check-circle text-green-400 text-2xl drop-shadow-md"></i>';
        } else {
            dbStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...)';
            dbStatus.className = "text-xs text-red-300 mt-2 bg-black/20 px-2 py-1 rounded inline-block animate-pulse";
            topRightStatus.innerHTML = '<i class="fas fa-times-circle text-red-500 text-2xl drop-shadow-md"></i>';
        }
    }
    
    function populateTestTypes() {
        const select = document.getElementById('testType');
        select.innerHTML = '';
        
        // Default list if pref missing
        const visibleTypes = myPreferences.visibleTestTypes || ALL_TEST_TYPES;
        
        ALL_TEST_TYPES.forEach(type => {
            if(visibleTypes.includes(type)) {
                const option = document.createElement('option');
                option.value = type;
                option.text = type;
                select.appendChild(option);
            }
        });
        
        // If nothing visible, show default
        if(select.options.length === 0) {
            const option = document.createElement('option');
            option.value = "N"; option.text = "Nitrogen (N) - ‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô";
            select.appendChild(option);
        }
    }

    // --- SYSTEM INIT ---
    async function initSystem() { 
        window.populateCameraList = populateCameraList; 
        updateSystemStatus(false);
        await loadUsersList(); 
        
        // Auto-load admin data if not logged in (Guest Mode)
        if (!currentUser) {
            await loadUserData('admin');
        }

        setTimeout(() => {
             if(document.getElementById('inputR')) {
                 updateInterfaceState();
                 updateInputDisplay();
             }
             populateCameraList();
             updateSystemStatus(true);
        }, 500);
    }

    // ... (User Loading & Storage functions same as before) ...
    async function loadUsersList() {
        const storedUsers = await StorageEngine.get('soil_sys_users');
        if (storedUsers) {
            const parsed = JSON.parse(storedUsers);
            if(parsed.users) users = parsed.users;
            else users = parsed;
        } else {
            users = JSON.parse(JSON.stringify(DEFAULT_USERS));
            StorageEngine.set('soil_sys_users', JSON.stringify({ users: users, timestamp: Date.now() }));
        }
    }

    async function loadUserData(username) {
        // showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."); // Disabled for smoother non-blocking
        const key = `soil_settings_${username}`;
        try {
            const storedStr = await StorageEngine.get(key);
            let finalData = null;
            if (storedStr) finalData = JSON.parse(storedStr);
            if (finalData) {
                mySoilData = finalData.soilData || [];
                // Merge preferences safely
                myPreferences = { ...myPreferences, ...finalData.preferences };
                if(!myPreferences.visibleTestTypes) myPreferences.visibleTestTypes = [...ALL_TEST_TYPES];
            } else {
                mySoilData = JSON.parse(JSON.stringify(DEFAULT_SOIL_DATA));
                // Only auto-save if admin to initialize
                if(username === 'admin') saveUserData();
            }
        } catch (e) {
            console.error("Load Error", e);
            mySoilData = JSON.parse(JSON.stringify(DEFAULT_SOIL_DATA));
        }
        
        // Apply settings after load
        populateTestTypes();
    }

    // New "Optimistic Save" Logic:
    // Update local -> Render -> Trigger Cloud Save without awaiting
    async function saveUserData() {
        // If guest, don't save to cloud unless it's initial admin load
        const targetUser = currentUser ? currentUser.username : 'admin';
        // Guest mode read-only check can be here if needed
        
        const key = `soil_settings_${targetUser}`;
        const payload = {
            timestamp: Date.now(),
            soilData: mySoilData,
            preferences: myPreferences
        };
        const strPayload = JSON.stringify(payload);
        
        localStorage.setItem(key, strPayload);
        
        // Fire and forget, show status
        showSyncBadge(true);
        StorageEngine.set(key, strPayload)
        .then(() => { setTimeout(() => showSyncBadge(false), 2000); })
        .catch(() => showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Cloud ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)", "error"));
    }
    
    async function saveSystemUsers() {
        showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...");
        const payload = { users: users, timestamp: Date.now() };
        await StorageEngine.set('soil_sys_users', JSON.stringify(payload));
        showLoading(false);
    }

    // ... (UI Helper functions) ...
    function showLoading(show, text="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...") {
        const overlay = document.getElementById('loadingOverlay');
        const txt = document.getElementById('loadingText');
        if(txt) txt.innerText = text;
        if(show) overlay.classList.remove('hidden');
        else overlay.classList.add('hidden');
    }
    
    function showSyncBadge(show, text="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...") {
        const badge = document.getElementById('syncBadge');
        if(show) {
            badge.innerHTML = `<i class="fas fa-sync fa-spin"></i> ${text}`;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
    
    function showToast(message, type="success") {
        const toast = document.getElementById('statusToast');
        const icon = document.getElementById('toastIcon');
        const msg = document.getElementById('toastMessage');
        toast.className = `status-toast show ${type === 'error' ? 'bg-red-800' : 'bg-gray-800'}`;
        icon.innerHTML = type === 'error' ? '<i class="fas fa-exclamation-circle text-red-400"></i>' : '<i class="fas fa-check-circle text-green-400"></i>';
        msg.innerText = message;
        toast.style.display = 'flex';
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    // --- CALIBRATION FUNCTIONS (NEW) ---
    function calibrateSystem() {
        if (lastRawRGB.r === 0 && lastRawRGB.g === 0 && lastRawRGB.b === 0) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Calibrate");
            return;
        }

        calibrationOffsets.r = 255 - lastRawRGB.r;
        calibrationOffsets.g = 255 - lastRawRGB.g;
        calibrationOffsets.b = 255 - lastRawRGB.b;

        const avgRaw = (lastRawRGB.r + lastRawRGB.g + lastRawRGB.b) / 3;
        const percent = Math.round((avgRaw / 255) * 100);
        let statusMsg = "";
        let statusColor = "";

        if (percent > 95) {
            statusMsg = `‡πÅ‡∏™‡∏á‡∏î‡∏µ‡∏°‡∏≤‡∏Å (${percent}%) - ‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠`;
            statusColor = "text-green-600";
        } else if (percent > 80) {
            statusMsg = `‡πÅ‡∏™‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (${percent}%) - ‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢`;
            statusColor = "text-yellow-600";
        } else {
            statusMsg = `‡πÅ‡∏™‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (${percent}%) - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡πÅ‡∏™‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß`;
            statusColor = "text-red-600";
        }

        document.getElementById('calibrationStatus').innerHTML = `<strong>Status:</strong> Calibrated (R+${calibrationOffsets.r}, G+${calibrationOffsets.g}, B+${calibrationOffsets.b})`;
        const lightEl = document.getElementById('lightQualityStatus');
        lightEl.innerText = statusMsg;
        lightEl.className = "text-xs font-bold mt-1 " + statusColor;

        showToast("Calibrate ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡πà‡∏≤‡πÅ‡∏™‡∏á‡∏ñ‡∏π‡∏Å‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        updateInputDisplay(); 
    }

    function resetCalibration() {
        calibrationOffsets = { r: 0, g: 0, b: 0 };
        document.getElementById('calibrationStatus').innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Calibrate (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏î‡∏¥‡∏ö)";
        document.getElementById('lightQualityStatus').innerText = "‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÅ‡∏™‡∏á: ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î...";
        document.getElementById('lightQualityStatus').className = "text-xs font-bold mt-1 text-gray-500";
        showToast("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÅ‡∏™‡∏á‡πÅ‡∏•‡πâ‡∏ß");
    }

    // --- TABLE ACTIONS (FAST UI) ---
    function saveRange() {
        const fields = ['newType', 'newLevel', 
            'newRMin', 'newRMax', 'newGMin', 'newGMax', 'newBMin', 'newBMax',
            'newHMin', 'newHMax', 'newSMin', 'newSMax', 'newVMin', 'newVMax'
        ];
        
        const vals = {};
        fields.forEach(id => vals[id] = document.getElementById(id).value);
        
        if(!vals.newType || !vals.newLevel) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Type ‡πÅ‡∏•‡∏∞ Level"); return; }
        
        // Construct New Data
        const newData = {
            type: vals.newType,
            level: vals.newLevel
        };

        // Add RGB if valid
        if(vals.newRMin !== "") {
            newData.r = [parseInt(vals.newRMin), parseInt(vals.newRMax)];
            newData.g = [parseInt(vals.newGMin), parseInt(vals.newGMax)];
            newData.b = [parseInt(vals.newBMin), parseInt(vals.newBMax)];
        }

        // Add HSV if valid
        if(vals.newHMin !== "") {
            newData.h = [parseInt(vals.newHMin), parseInt(vals.newHMax)];
            newData.s = [parseInt(vals.newSMin), parseInt(vals.newSMax)];
            newData.v = [parseInt(vals.newVMin), parseInt(vals.newVMax)];
        }

        if(editIndex >= 0) { mySoilData[editIndex] = newData; } else { mySoilData.push(newData); }
        cancelEdit(); renderConfigTable(); saveUserData();
    }

    function removeRange(i) {
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ?")) {
            if(editIndex === i) cancelEdit();
            mySoilData.splice(i, 1);
            renderConfigTable(); saveUserData();
        }
    }

    // --- IMPORT EXCEL (FIXED) ---
    function triggerImportXLSX() { document.getElementById('xlsxFileInput').click(); }
    function handleImportXLSX(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (typeof XLSX === 'undefined') { alert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ Excel..."); return; }
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                const newData = [];
                for(let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if(row && row.length >= 8) { 
                        // Enhanced Import to include HSV if present (assuming columns 8-13)
                        const entry = {
                            type: String(row[0] || "Unknown"), level: String(row[1] || "Unknown")
                        };
                        // RGB
                        if(row[2] !== undefined && row[2] !== "" && row[2] !== null) {
                             entry.r = [parseInt(row[2]), parseInt(row[3])];
                             entry.g = [parseInt(row[4]), parseInt(row[5])];
                             entry.b = [parseInt(row[6]), parseInt(row[7])];
                        }
                        // HSV (Optional - Cols 8-13)
                        if(row[8] !== undefined && row[8] !== "" && row[8] !== null) {
                            entry.h = [parseInt(row[8]), parseInt(row[9])];
                            entry.s = [parseInt(row[10]), parseInt(row[11])];
                            entry.v = [parseInt(row[12]), parseInt(row[13])];
                        }
                        newData.push(entry);
                    }
                }
                if(newData.length > 0) {
                    if(confirm(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${newData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤?`)) {
                        mySoilData = newData; renderConfigTable(); saveUserData(); alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    }
                } else { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); }
            } catch (err) { alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
    }
    
    // --- EXPORT ---
    function exportXLSX() {
        if(!mySoilData || mySoilData.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); return; }
        const ws_data = [["Type", "Level", "R_Min", "R_Max", "G_Min", "G_Max", "B_Min", "B_Max", "H_Min", "H_Max", "S_Min", "S_Max", "V_Min", "V_Max"]];
        mySoilData.forEach(d => { 
            const row = [d.type, d.level];
            if(d.r) row.push(d.r[0], d.r[1], d.g[0], d.g[1], d.b[0], d.b[1]);
            else row.push("", "", "", "", "", "");
            
            if(d.h) row.push(d.h[0], d.h[1], d.s[0], d.s[1], d.v[0], d.v[1]);
            else row.push("", "", "", "", "", "");
            
            ws_data.push(row);
        });
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "SoilData");
        XLSX.writeFile(wb, "soil_data.xlsx");
    }

    // --- RENDER & EDIT ---
    function renderConfigTable() {
        const tbody = document.getElementById('configTableBody');
        if(!tbody) return;
        tbody.innerHTML = '';
        mySoilData.forEach((d, i) => {
            const rgbStr = d.r ? `${d.r[0]}-${d.r[1]}` : '-';
            const hsvStr = d.h ? `${d.h[0]}-${d.h[1]}` : '-';
            
            tbody.innerHTML += `
            <tr class="bg-white border-b hover:bg-gray-50 text-xs">
                <td class="px-3 py-2 font-bold">${d.type}</td>
                <td class="px-3 py-2">${d.level}</td>
                
                <td class="px-1 py-2 text-center text-red-600 bg-red-50">${d.r ? d.r[0]+'-'+d.r[1] : ''}</td>
                <td class="px-1 py-2 text-center text-green-600 bg-green-50">${d.g ? d.g[0]+'-'+d.g[1] : ''}</td>
                <td class="px-1 py-2 text-center text-blue-600 bg-blue-50">${d.b ? d.b[0]+'-'+d.b[1] : ''}</td>
                
                <td class="px-1 py-2 text-center text-indigo-600 bg-indigo-50 border-l">${d.h ? d.h[0]+'-'+d.h[1] : ''}</td>
                <td class="px-1 py-2 text-center text-indigo-600 bg-indigo-50">${d.s ? d.s[0]+'-'+d.s[1] : ''}</td>
                <td class="px-1 py-2 text-center text-indigo-600 bg-indigo-50">${d.v ? d.v[0]+'-'+d.v[1] : ''}</td>
                
                <td class="px-3 py-2 text-center flex gap-1 justify-center">
                    <button onclick="startEdit(${i})" class="text-blue-500 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="removeRange(${i})" class="text-red-500"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }

    function startEdit(index) {
        editIndex = index;
        const item = mySoilData[index];
        const fields = ['newType', 'newLevel', 'newRMin', 'newRMax', 'newGMin', 'newGMax', 'newBMin', 'newBMax', 'newHMin', 'newHMax', 'newSMin', 'newSMax', 'newVMin', 'newVMax'];
        
        document.getElementById('newType').value = item.type;
        document.getElementById('newLevel').value = item.level;
        
        if(item.r) {
            document.getElementById('newRMin').value = item.r[0]; document.getElementById('newRMax').value = item.r[1];
            document.getElementById('newGMin').value = item.g[0]; document.getElementById('newGMax').value = item.g[1];
            document.getElementById('newBMin').value = item.b[0]; document.getElementById('newBMax').value = item.b[1];
        } else {
             ['newRMin', 'newRMax', 'newGMin', 'newGMax', 'newBMin', 'newBMax'].forEach(id => document.getElementById(id).value = '');
        }

        if(item.h) {
            document.getElementById('newHMin').value = item.h[0]; document.getElementById('newHMax').value = item.h[1];
            document.getElementById('newSMin').value = item.s[0]; document.getElementById('newSMax').value = item.s[1];
            document.getElementById('newVMin').value = item.v[0]; document.getElementById('newVMax').value = item.v[1];
        } else {
             ['newHMin', 'newHMax', 'newSMin', 'newSMax', 'newVMin', 'newVMax'].forEach(id => document.getElementById(id).value = '');
        }

        document.getElementById('formTitle').innerText = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${index + 1}`;
        document.getElementById('btnSaveRange').innerHTML = '<i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
        document.getElementById('btnSaveRange').className = "bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 text-sm flex-1";
        document.getElementById('btnCancelEdit').classList.remove('hidden');
        document.getElementById('formTitle').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
        editIndex = -1;
        document.getElementById('formTitle').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà';
        document.getElementById('btnSaveRange').innerHTML = '<i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        document.getElementById('btnSaveRange').className = "bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm flex-1";
        document.getElementById('btnCancelEdit').classList.add('hidden');
        const fields = ['newType', 'newLevel', 'newRMin', 'newRMax', 'newGMin', 'newGMax', 'newBMin', 'newBMax', 'newHMin', 'newHMax', 'newSMin', 'newSMax', 'newVMin', 'newVMax'];
        fields.forEach(id => document.getElementById(id).value = '');
    }
    
    // --- ADMIN SETTINGS RENDER ---
    function renderAdminSettings() {
        const container = document.getElementById('settingsContainer');
        container.innerHTML = '';
        
        // 1. Visible Test Types
        ALL_TEST_TYPES.forEach(type => {
            const div = document.createElement('div');
            div.className = "flex items-center";
            const checked = myPreferences.visibleTestTypes.includes(type) ? 'checked' : '';
            div.innerHTML = `
                <input type="checkbox" id="chk_${type}" class="w-4 h-4 text-emerald-600 rounded" ${checked} onchange="toggleTestTypeVisibility('${type}')">
                <label for="chk_${type}" class="ml-2 text-sm text-gray-700">${type}</label>
            `;
            container.appendChild(div);
        });

        // Separator
        const hr = document.createElement('hr');
        hr.className = "my-2 border-yellow-200";
        container.appendChild(hr);

        // 2. RGB Adjust Visibility
        const divRGB = document.createElement('div');
        divRGB.className = "flex items-center";
        divRGB.innerHTML = `
            <input type="checkbox" id="chk_showRGBAdjust" class="w-4 h-4 text-emerald-600 rounded" ${myPreferences.showRGBAdjust ? 'checked' : ''} onchange="toggleSectionVisibility('showRGBAdjust')">
            <label for="chk_showRGBAdjust" class="ml-2 text-sm text-gray-700 font-bold">‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á RGB</label>
        `;
        container.appendChild(divRGB);

        // 3. Calibration Visibility
        const divCalib = document.createElement('div');
        divCalib.className = "flex items-center";
        divCalib.innerHTML = `
            <input type="checkbox" id="chk_showCalibration" class="w-4 h-4 text-emerald-600 rounded" ${myPreferences.showCalibration ? 'checked' : ''} onchange="toggleSectionVisibility('showCalibration')">
            <label for="chk_showCalibration" class="ml-2 text-sm text-gray-700 font-bold">‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô Calibration</label>
        `;
        container.appendChild(divCalib);
    }

    function toggleTestTypeVisibility(type) {
        if(myPreferences.visibleTestTypes.includes(type)) {
            myPreferences.visibleTestTypes = myPreferences.visibleTestTypes.filter(t => t !== type);
        } else {
            myPreferences.visibleTestTypes.push(type);
        }
        saveUserData();
        populateTestTypes();
    }

    function toggleSectionVisibility(settingKey) {
        myPreferences[settingKey] = !myPreferences[settingKey];
        saveUserData();
        updateInterfaceState();
    }

    async function handleLogin(e) {
        e.preventDefault();
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        showLoading(true, "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...");
        await loadUsersList(); showLoading(false);
        const foundUser = users.find(user => user.username === u && user.password === p);
        if (foundUser) performLogin(foundUser); else document.getElementById('loginError').classList.remove('hidden');
    }

    async function performLogin(user) {
        currentUser = user;
        await loadUserData(user.username);
        document.getElementById('login-panel').classList.add('hidden');
        document.getElementById('admin-panel').classList.remove('hidden');
        document.getElementById('userInfoDisplay').classList.remove('hidden');
        document.getElementById('loggedInUser').innerText = `üë§ ${user.username}`;
        const userManageBtn = document.getElementById('menu-user-manage');
        if (user.role === 'admin') userManageBtn.classList.remove('hidden'); else userManageBtn.classList.add('hidden');
        document.getElementById('toggleBrightness').checked = myPreferences.showBrightness;
        document.getElementById('toggleRealTime').checked = myPreferences.useRealTimeAnalysis;
        toggleBrightnessSetting(false);
        toggleRealTimeSetting(false);
        populateCameraList();
        renderConfigTable();
        renderUserTable();
        // Render Settings checkboxes
        renderAdminSettings();
        
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('loginError').classList.add('hidden');
    }

    function logout() {
        if(isCameraActive) stopCameraStream();
        currentUser = null;
        updateSystemStatus(false);
        loadUserData('admin').then(() => { updateInputDisplay(); renderConfigTable(); updateSystemStatus(true); });
        document.getElementById('userInfoDisplay').classList.add('hidden');
        if(!document.getElementById('tab-config').classList.contains('hidden')) {
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('login-panel').classList.remove('hidden');
        }
        switchTab('analyze');
    }

    function switchAdminTab(subTab) {
        if (subTab === 'user-manage' && (!currentUser || currentUser.role !== 'admin')) { alert("‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"); return; }
        ['admin-color-config', 'admin-user-manage', 'admin-change-pass'].forEach(id => document.getElementById(id).classList.add('hidden'));
        ['menu-color-config', 'menu-user-manage', 'menu-change-pass'].forEach(id => document.getElementById(id).className = "w-full text-left px-4 py-2 rounded hover:bg-white hover:shadow font-medium text-gray-600");
        document.getElementById('admin-' + subTab).classList.remove('hidden');
        document.getElementById('menu-' + subTab).className = "w-full text-left px-4 py-2 rounded hover:bg-white hover:shadow font-medium text-emerald-700 bg-white shadow";
        
        if(subTab === 'color-config') renderAdminSettings();
    }

    async function toggleBrightnessSetting(save=true) {
        const val = document.getElementById('toggleBrightness').checked;
        const div = document.getElementById('brightnessContainer');
        if(div) { if(val) div.classList.remove('hidden'); else div.classList.add('hidden'); }
        if(save && currentUser) { myPreferences.showBrightness = val; saveUserData(); }
    }

    function updateInterfaceState() {
        const btn = document.getElementById('btnManualAnalyze');
        const statusTxt = document.getElementById('autoAnalyzeStatus');
        
        // Visibility Toggles
        const rgbSection = document.getElementById('rgbAdjustSection');
        const calibSection = document.getElementById('calibrationSection');
        if(rgbSection) rgbSection.style.display = myPreferences.showRGBAdjust !== false ? 'block' : 'none';
        if(calibSection) calibSection.style.display = myPreferences.showCalibration !== false ? 'block' : 'none';

        if(!btn || !statusTxt) return;
        if (myPreferences.useRealTimeAnalysis) { btn.classList.add('hidden'); statusTxt.innerText = ""; analyzeSoil(); } 
        else { btn.classList.remove('hidden'); statusTxt.innerText = ""; }
        const checkbox = document.getElementById('toggleRealTime');
        if(checkbox) checkbox.checked = myPreferences.useRealTimeAnalysis;
        
        populateTestTypes();
    }

    async function toggleRealTimeSetting(save=true) {
        const isChecked = document.getElementById('toggleRealTime').checked;
        if(save && currentUser) {
            myPreferences.useRealTimeAnalysis = isChecked;
            await executeWithSaving(async()=>{});
        } else {
             myPreferences.useRealTimeAnalysis = isChecked;
        }
        updateInterfaceState();
    }
    
    function updateCameraSelection() {
        if(currentUser) {
            myPreferences.selectedCameraId = document.getElementById('cameraSelect').value;
            saveUserData(); 
        }
    }

    function renderUserTable() {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';
        users.forEach((u, i) => {
            tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="px-4 py-2 font-medium">${u.username}</td><td class="px-4 py-2 text-xs">${u.role}</td><td class="px-4 py-2 text-right">${u.username !== 'admin' ? `<button onclick="deleteUser(${i})" class="text-red-500"><i class="fas fa-trash"></i></button>` : ''}</td></tr>`;
        });
    }

    async function addUser() {
        const u = document.getElementById('newUsername').value;
        const p = document.getElementById('newPassword').value;
        if(u && p) {
            if(users.some(x => x.username === u)) { alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥"); return; }
            users.push({ id: Date.now(), username: u, password: p, role: 'user' });
            await saveSystemUsers();
            renderUserTable(); alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
    }

    async function deleteUser(i) {
        if(confirm("‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ?")) {
            users.splice(i, 1);
            await saveSystemUsers();
            renderUserTable();
        }
    }

    async function changePassword() {
        const p1 = document.getElementById('changeNewPass').value;
        const p2 = document.getElementById('changeConfirmPass').value;
        if(p1 !== p2 || p1.length < 3) { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }
        const idx = users.findIndex(u => u.username === currentUser.username);
        if(idx !== -1) {
            users[idx].password = p1;
            await saveSystemUsers();
            alert("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
    }

    function switchTab(selectedTab) {
        if(selectedTab === 'config' && !currentUser) {
            document.getElementById('tab-analyze').classList.add('hidden');
            document.getElementById('tab-config').classList.remove('hidden');
            document.getElementById('login-panel').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
        } else if (selectedTab === 'config') {
            document.getElementById('tab-analyze').classList.add('hidden');
            document.getElementById('tab-config').classList.remove('hidden');
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
        } else {
            document.getElementById('tab-analyze').classList.remove('hidden');
            document.getElementById('tab-config').classList.add('hidden');
        }
        ['analyze', 'config'].forEach(tab => {
            const btn = document.getElementById('btn-'+tab);
            if(tab === selectedTab) btn.className="flex-1 py-3 text-emerald-600 border-b-2 border-emerald-600 font-bold focus:outline-none transition";
            else btn.className="flex-1 py-3 text-gray-500 hover:text-emerald-500 font-medium focus:outline-none transition";
        });
    }

    function toggleCamera() {
        const container = document.getElementById('mediaContainer');
        const video = document.getElementById('videoElement');
        const img = document.getElementById('imagePreview');
        const btnFlip = document.getElementById('btnFlipCamera');

        if (isCameraActive) {
            stopCameraStream();
            container.classList.add('hidden');
            btnFlip.classList.add('hidden');
        } else {
            container.classList.remove('hidden');
            img.classList.add('hidden');
            btnFlip.classList.remove('hidden');
            let constraints = { video: { facingMode: currentFacingMode } };
            if (myPreferences.selectedCameraId) constraints.video = { deviceId: { exact: myPreferences.selectedCameraId } };
            navigator.mediaDevices.getUserMedia(constraints).then(stream => {
                videoStream = stream;
                video.srcObject = stream;
                isCameraActive = true;
                video.onloadedmetadata = () => drawVideoToCanvasLoop();
            }).catch(e => alert("Camera Error: " + e));
        }
    }

    function switchCamera(e) {
        if(e) e.stopPropagation();
        if(!isCameraActive) return;
        currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
        stopCameraStream();
        navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } }).then(stream => {
            videoStream = stream;
            document.getElementById('videoElement').srcObject = stream;
            isCameraActive = true;
            drawVideoToCanvasLoop();
        });
    }

    function stopCameraStream() {
        if(videoStream) videoStream.getTracks().forEach(t => t.stop());
        isCameraActive = false;
    }

    function drawVideoToCanvasLoop() {
        if(!isCameraActive) return;
        const vid = document.getElementById('videoElement');
        const cvs = document.getElementById('canvasElement');
        const ctx = cvs.getContext('2d');
        if(vid.readyState === vid.HAVE_ENOUGH_DATA) {
            if(cvs.width !== vid.videoWidth) { cvs.width = vid.videoWidth; cvs.height = vid.videoHeight; }
            ctx.drawImage(vid, 0, 0);
            if(markerPosition) processAreaColor(cvs, markerPosition.x, markerPosition.y);
            // Center Reticle Logic
            else if (!isAnalysisPaused) {
                 const rect = cvs.getBoundingClientRect();
                 processAreaColor(cvs, rect.width/2 + rect.left, rect.height/2 + rect.top);
            }
        }
        requestAnimationFrame(drawVideoToCanvasLoop);
    }

    function handleMediaClick(e) {
        if(e.target.closest('button')) return;
        const rect = e.currentTarget.getBoundingClientRect();
        markerPosition = { x: e.clientX, y: e.clientY };
        const marker = document.getElementById('colorMarker');
        marker.style.display = 'block';
        marker.style.left = (e.clientX - rect.left) + 'px';
        marker.style.top = (e.clientY - rect.top) + 'px';
        if(!isCameraActive) processAreaColor(document.getElementById('canvasElement'), e.clientX, e.clientY);
    }

    function processAreaColor(cvs, cx, cy) {
        if (isCameraActive && isAnalysisPaused) return; // Respect pause

        const rect = cvs.getBoundingClientRect();
        const scaleX = cvs.width / rect.width;
        const scaleY = cvs.height / rect.height;
        const sx = Math.floor(((cx - rect.left) * scaleX) - 15);
        const sy = Math.floor(((cy - rect.top) * scaleY) - 15);
        try {
            const data = cvs.getContext('2d').getImageData(sx, sy, 30, 30).data;
            let r=0, g=0, b=0, c=0;
            for(let i=0; i<data.length; i+=4) { r+=data[i]; g+=data[i+1]; b+=data[i+2]; c++; }
            if(c>0) {
                // Apply Calibration Offset
                lastRawRGB = { r: Math.round(r/c), g: Math.round(g/c), b: Math.round(b/c) };
                
                // Clamp values 0-255
                let finalR = Math.min(255, Math.max(0, lastRawRGB.r + calibrationOffsets.r));
                let finalG = Math.min(255, Math.max(0, lastRawRGB.g + calibrationOffsets.g));
                let finalB = Math.min(255, Math.max(0, lastRawRGB.b + calibrationOffsets.b));

                document.getElementById('inputR').value = finalR;
                document.getElementById('inputG').value = finalG;
                document.getElementById('inputB').value = finalB;
                document.getElementById('valBrightness').innerText = Math.round(((finalR)*299 + (finalG)*587 + (finalB)*114)/1000);
                updateInputDisplay();
            }
        } catch(e){}
    }
    
    function triggerFileUpload() { document.getElementById('fileInput').click(); }
    
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (isCameraActive) toggleCamera(); 
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('imagePreview');
            img.src = e.target.result;
            document.getElementById('mediaContainer').classList.remove('hidden');
            document.getElementById('btnFlipCamera').classList.add('hidden');
            img.classList.remove('hidden');
            document.getElementById('colorMarker').style.display = 'none';
            markerPosition = null;
            img.onload = function() {
                const canvas = document.getElementById('canvasElement');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                canvas.getContext('2d').drawImage(img, 0, 0);
            }
        };
        reader.readAsDataURL(file);
    }

    // PDF GENERATION 
    async function generatePDFReport() {
        showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF...");
        const now = new Date();
        document.getElementById('reportDate').innerText = now.toLocaleString('th-TH');
        document.getElementById('reportUser').innerText = currentUser ? currentUser.username : 'Guest';
        document.getElementById('reportResultLevel').innerText = document.getElementById('resultText').innerText;
        document.getElementById('reportResultType').innerText = document.getElementById('testType').value;
        document.getElementById('reportR').innerText = document.getElementById('inputR').value;
        document.getElementById('reportG').innerText = document.getElementById('inputG').value;
        document.getElementById('reportB').innerText = document.getElementById('inputB').value;
        
        // ADD HSV REPORTING
        const hsv = rgbToHsv(document.getElementById('inputR').value, document.getElementById('inputG').value, document.getElementById('inputB').value);
        document.getElementById('reportH').innerText = hsv.h + '¬∞';
        document.getElementById('reportS').innerText = hsv.s + '%';
        document.getElementById('reportV').innerText = hsv.v + '%';

        document.getElementById('reportBrightness').innerText = document.getElementById('valBrightness').innerText;
        
        const mediaContainer = document.getElementById('mediaContainer');
        const video = document.getElementById('videoElement');
        const imgEl = document.getElementById('imagePreview');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const w = mediaContainer.offsetWidth;
        const h = mediaContainer.offsetHeight;
        canvas.width = w;
        canvas.height = h;
        if (!imgEl.classList.contains('hidden')) { ctx.drawImage(imgEl, 0, 0, w, h); } else { ctx.drawImage(video, 0, 0, w, h); }
        if (markerPosition) {
             const marker = document.getElementById('colorMarker');
             const left = parseFloat(marker.style.left) || w/2;
             const top = parseFloat(marker.style.top) || h/2;
             ctx.strokeStyle = '#00ff00';
             ctx.lineWidth = 3;
             ctx.strokeRect(left - 15, top - 15, 30, 30);
        }
        document.getElementById('reportImage').src = canvas.toDataURL('image/jpeg');
        const template = document.getElementById('reportTemplate');
        template.classList.remove('hidden');
        try {
            const canvasReport = await html2canvas(template, { scale: 2 });
            const imgData = canvasReport.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvasReport.height * pdfWidth) / canvasReport.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(`Soil_Report_${now.getTime()}.pdf`);
            showToast("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        } catch(err) {
            console.error(err);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF");
        } finally {
            template.classList.add('hidden');
            showLoading(false);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initSystem();
    });

</script>
</body>
</html>
